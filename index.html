<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotaract Club Invoice Calculator | Rotaract South Asia MDIO</title>
    <meta name="description" content="Rotaract Club Invoice Calculator is an interactive tool by Rotaract South Asia MDIO (RSAMDIO) to help Rotaractors estimate their Club Invoices with precision and ease.">
    <meta name="author" content="ZeoSpec">
    <link rel="canonical" href="https://dues.rsamdio.org/">
    
    <!-- Essential Open Graph tags only -->
    <meta property="og:title" content="Rotaract Club Invoice Calculator | Rotaract South Asia MDIO">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://dues.rsamdio.org/">
    <meta property="og:image" content="https://dues.rsamdio.org/calculatorogimg.png">
    <meta property="og:description" content="Rotaract Club Invoice Calculator is an interactive tool by Rotaract South Asia MDIO (RSAMDIO) to help Rotaractors estimate their Club Invoices with precision and ease.">
    
    <!-- Cache optimization -->
    <meta http-equiv="cache-control" content="public, max-age=31536000">
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
    <link rel="icon" href="favicon.png" type="image/x-icon">
	

    <!-- Preload critical resources -->
    <link rel="preload" href="styles.css" as="style">
    <link rel="preload" href="app.js" as="script">
    <link rel="preload" href="rsamdio.png" as="image">
    
    <!-- Load fonts efficiently -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>
    
    <!-- Critical CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Defer Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com" defer></script>
    
    <!-- Load utility libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Critical CSS only - rest moved to external file -->
    <style>
        /* Critical above-the-fold styles only */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
            color: #4a5568;
            margin: 0;
            padding: 0;
        }
        
        /* Essential loading states */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
    </style>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z4F8DL7KLQ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-Z4F8DL7KLQ');
        
        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    if (perfData) {
                        gtag('event', 'timing_complete', {
                            name: 'load',
                            value: Math.round(perfData.loadEventEnd - perfData.loadEventStart)
                        });
                    }
                }, 0);
            });
        }
    </script>

    <!-- Load PDF libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <!-- External JavaScript for better performance -->
    <script src="app.js" defer></script>

</head>
<body class="antialiased">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full mx-auto mb-4"></div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Generating Detailed Report</h3>
            <p id="loading-message" class="text-gray-600 font-medium mb-4">Preparing...</p>
            
            <div class="loading-progress">
                <div id="loading-progress-bar" class="loading-progress-bar"></div>
            </div>
            
            <div class="loading-steps">
                <div id="step-1" class="loading-step active">
                    <div class="w-2 h-2 bg-blue-500 rounded-full mb-1"></div>
                    <span>Prepare</span>
                </div>
                <div id="step-2" class="loading-step">
                    <div class="w-2 h-2 bg-gray-300 rounded-full mb-1"></div>
                    <span>Process</span>
                </div>
                <div id="step-3" class="loading-step">
                    <div class="w-2 h-2 bg-gray-300 rounded-full mb-1"></div>
                    <span>Generate</span>
                </div>
                <div id="step-4" class="loading-step">
                    <div class="w-2 h-2 bg-gray-300 rounded-full mb-1"></div>
                    <span>Complete</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="text-center mb-12">
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-3xl p-8 mb-8 border border-blue-100">
                <picture>
                    <source srcset="rsamdio.webp" type="image/webp">
                    <source srcset="rsamdio.png" type="image/png">
                    <img src="rsamdio.png" alt="RSAMDIO Logo" class="mx-auto h-24 mb-6 drop-shadow-lg" loading="eager">
                </picture>
                <h1 class="text-4xl sm:text-5xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent mb-4">Rotaract Club Invoice Calculator</h1>
                <p class="text-lg text-gray-600 max-w-3xl mx-auto leading-relaxed">An interactive tool to help Rotaractors estimate their Club Invoices with precision and ease.</p>
                <div class="flex items-center justify-center mt-6 space-x-4 text-sm text-gray-500">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Easy to use
                    </div>
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Bulk upload support
                    </div>
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Real-time calculations
                    </div>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Add Member & Bulk Upload -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Add New Member Card -->
                <div class="card p-6 shadow-lg border-0">
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">Add New Member</h2>
                        <p class="text-sm text-gray-500 mt-1">Add individual members to your roster</p>
                    </div>
                    <form id="add-member-form" class="space-y-5">
                        <div class="form-group space-y-2">
                            <label for="member-name" class="block text-sm font-semibold text-gray-700 text-center">Member Name <span class="text-red-500">*</span></label>
                            <input type="text" id="member-name" 
                                   class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-center"
                                   placeholder="Enter member's full name"
                                   aria-describedby="member-name-error">
                            <div id="member-name-error" class="error-message text-center"></div>
                        </div>
                        <div class="form-group space-y-2">
                            <label for="member-type" class="block text-sm font-semibold text-gray-700 text-center">Club Base <span class="text-red-500">*</span></label>
                            <select id="member-type" 
                                    class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-center"
                                    aria-describedby="member-type-error">
                                <option value="">Select Club Base</option>
                                <option value="Community-Based">Community-Based ($8)</option>
                                <option value="University-Based">University-Based ($5)</option>
                            </select>
                            <div id="member-type-error" class="error-message text-center"></div>
                        </div>
                        <div class="form-group space-y-2">
                            <label for="join-date" class="block text-sm font-semibold text-gray-700 text-center">Join Date <span class="text-red-500">*</span></label>
                            <input type="date" id="join-date" 
                                   class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-center"
                                   aria-describedby="join-date-error">
                            <div id="join-date-error" class="error-message text-center"></div>
                        </div>
                        <div class="form-group space-y-2">
                            <label for="leave-date" class="block text-sm font-semibold text-gray-700 text-center">Leave Date (Optional)</label>
                            <input type="date" id="leave-date" 
                                   class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-center"
                                   placeholder="Leave blank if still active"
                                   aria-describedby="leave-date-error">
                            <div id="leave-date-error" class="error-message text-center"></div>
                        </div>
                        <button type="submit" id="add-member-button" class="btn btn-primary w-full !mt-6 py-3 text-base font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                            Add Member
                        </button>
                    </form>
                </div>

                <!-- Bulk Upload Card -->
                <div class="card p-6 shadow-lg border-0">
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">Bulk Upload Roster</h2>
                        <p class="text-sm text-gray-500 mt-1">Upload multiple members at once</p>
                    </div>
                    
                    <!-- File Upload Area -->
                    <div id="file-upload-area" class="file-upload-area upload-area-container p-8 text-center mb-6 bg-gradient-to-br from-gray-50 to-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p class="text-base text-gray-600 mb-3 font-medium">Drag and drop your file here, or</p>
                        <input type="file" id="file-input" accept=".xlsx,.xls,.csv" class="hidden">
                        <button type="button" id="browse-button" class="btn btn-secondary text-sm px-6 py-3 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Browse Files
                        </button>
                        <p class="text-xs text-gray-500 mt-3">Supports Excel (.xlsx, .xls) and <br><b>CSV (Recommended)</b> files </p>
                    </div>
                    
                    <!-- File Upload Error Display -->
                    <div id="file-upload-error" class="hidden mb-4"></div>
                    
                    <!-- Upload Preview -->
                    <div id="upload-preview" class="hidden mb-6">
                        <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Preview
                        </h3>
                        <div id="preview-content" class="upload-preview bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm"></div>
                        <div class="flex gap-3 mt-4">
                            <button type="button" id="confirm-upload" class="btn btn-primary text-sm flex-1 py-3 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                                Add to Roster
                            </button>
                            <button type="button" id="cancel-upload" class="btn btn-secondary text-sm py-3 px-4 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- File Format Instructions -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-xl border border-blue-100 mb-6">
                        <h3 class="text-sm font-bold text-blue-800 mb-3 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Expected File Format
                        </h3>
                        <div class="text-sm text-blue-700 space-y-2">
                            <div class="flex items-center">
                                <span class="w-7 h-7 bg-blue-200 rounded-full flex items-center justify-center text-xs font-bold text-blue-800 mr-4 flex-shrink-0">A</span>
                                <div class="flex-1">
                                    <span class="font-semibold text-blue-800">Member Name</span>
                                    <span class="text-blue-600 ml-2">(e.g., John Doe)</span>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <span class="w-7 h-7 bg-blue-200 rounded-full flex items-center justify-center text-xs font-bold text-blue-800 mr-4 flex-shrink-0">B</span>
                                <div class="flex-1">
                                    <span class="font-semibold text-blue-800">Join Date</span>
                                    <span class="text-blue-600 ml-2">(YYYY-MM-DD format)</span>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <span class="w-7 h-7 bg-blue-200 rounded-full flex items-center justify-center text-xs font-bold text-blue-800 mr-4 flex-shrink-0">C</span>
                                <div class="flex-1">
                                    <span class="font-semibold text-blue-800">Club Base</span>
                                    <span class="text-blue-600 ml-2">(Community-Based or University-Based)</span>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <span class="w-7 h-7 bg-blue-200 rounded-full flex items-center justify-center text-xs font-bold text-blue-800 mr-4 flex-shrink-0">D</span>
                                <div class="flex-1">
                                    <span class="font-semibold text-blue-800">Leave Date</span>
                                    <span class="text-blue-600 ml-2">(YYYY-MM-DD format, leave blank if still active)</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-blue-200">
                            <div class="flex flex-col gap-3">
                                <button type="button" id="download-template" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    Download CSV Template
                                </button>
                                <a href="https://docs.google.com/spreadsheets/d/1pn3XA_MQyHFYIA4rn1i77qes_ujE533Orw7_fC8VFc4/copy" 
                                   target="_blank" 
                                   rel="noopener noreferrer"
                                   class="text-sm text-green-600 hover:text-green-800 font-medium flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    Make a Copy in Google Sheets
                                </a>
                            </div>
                        </div>
                    </div>


                </div>
            </div>

            <!-- Right Column: Summary & Roster -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Invoice Summary Card -->
                <div class="card p-8 shadow-lg border-0">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Invoice Summary</h2>
                        <p class="text-gray-500">View your estimated club invoice</p>
                    </div>
                    
                    <div class="mb-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Invoice Year Selection -->
                            <div class="bg-gradient-to-br from-gray-50 to-blue-50 p-6 rounded-xl border border-blue-100 shadow-sm hover:shadow-md transition-all duration-300">
                                <label for="invoice-year-select" class="block text-m font-bold text-blue-700 mb-3 text-center">Invoice of January</label>
                                <select id="invoice-year-select" class="w-full px-4 py-3 border-2 border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-center font-semibold bg-white shadow-sm">
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                                <div class="text-center mt-3">
                                    <div>        
                                        <p class="text-sm text-blue-600">Select the invoice year</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Tax Percentage Input -->
                            <div class="bg-gradient-to-br from-gray-50 to-green-50 p-6 rounded-xl border border-green-100 shadow-sm hover:shadow-md transition-all duration-300">
                                <label for="tax-percentage" class="block text-m font-bold text-green-700 mb-3 text-center">Tax Percentage (%)</label>
                                <div class="relative">
                                    <input type="number" id="tax-percentage" min="0" max="100" step="0.01" value="18" 
                                           class="w-full px-4 py-3 pr-12 border-2 border-green-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 text-center font-semibold bg-white shadow-sm" 
                                           placeholder="18">
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                        <span class="text-green-600 font-semibold">%</span>
                                    </div>
                                </div>
                                <div class="text-center mt-3">
                                    <div>
                                        <p class="text-sm text-green-600">Configure tax percentage</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-8 rounded-2xl border border-blue-100 text-center">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <p class="text-lg text-blue-700 font-semibold mb-2">Base RI Dues</p>
                                <p id="base-invoice-amount" class="text-4xl font-bold text-blue-800 tracking-tight my-2">$0.00</p>
                                <p id="dues-breakdown" class="text-sm text-gray-600">Full Year: $0.00 + Prorated: $0.00</p>
                            </div>
                            <div>
                                <p class="text-lg text-green-700 font-semibold mb-2">Total with Tax</p>
                                <p id="total-invoice-amount" class="text-4xl font-bold text-green-800 tracking-tight my-2">$0.00</p>
                                <p id="tax-breakdown" class="text-sm text-gray-600">Tax: $0.00 (18%)</p>
                            </div>
                        </div>
                        
                        <!-- Horizontal Line -->
                        <div class="border-t border-blue-200 my-6"></div>
                        
                        <!-- Additional Summary Data -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div class="text-center">
                                <p class="text-sm text-gray-500 font-medium mb-1">Members</p>
                                <p id="total-members" class="text-2xl font-semibold text-gray-700 tracking-tight">0</p>
                                <p class="text-xs text-gray-400">Total Full Year Dues</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500 font-medium mb-1">Months</p>
                                <p id="total-prorated-months" class="text-2xl font-semibold text-gray-700 tracking-tight">0</p>
                                <p class="text-xs text-gray-400">Total of Months in Prorata Calculation</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PDF Generation Section -->
                    <div class="mt-8 pt-6 border-t border-blue-200">

                        <button type="button" id="downloadPdfBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <span>Generate Detailed Report</span>
                        </button>
                        
                        <div id="pdfStatus" class="mt-3 text-center hidden">
                            <div class="inline-flex items-center space-x-2 text-blue-600">
                                <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span>Generating Detailed Report...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Member Roster Card -->
                <div class="card p-8 shadow-lg border-0">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
                        <div class="flex items-center mb-4 sm:mb-0">
                            <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center mr-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Member Roster</h2>
                                <p class="text-sm text-gray-500">Manage your club members</p>
                            </div>
                        </div>
                        <button id="reset-button" class="btn btn-secondary text-sm px-6 py-3 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Reset Roster
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto -mx-8 table-responsive">
                        <table class="min-w-full" role="table" aria-label="Member roster">
                            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                <tr>
                                    <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Join Date</th>
                                    <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Leave Date</th>
                                    <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Club Base</th>
                                    <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">
                                        Est. Base Due
                                        <div class="text-xs font-normal text-gray-500 normal-case mt-1">(Full Year + Prorated)</div>
                                    </th>
                                    <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Active Member</th>
                                    <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Prorated Months</th>
                                    <th scope="col" class="relative px-6 py-4"><span class="sr-only">Actions</span></th>
                                </tr>
                            </thead>
                            <tbody id="member-roster-body" class="bg-white divide-y divide-gray-100">
                                <!-- Rows will be dynamically injected here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div id="pagination-controls" class="mt-6 px-6 hidden">
                        <!-- Desktop Layout -->
                        <div class="hidden md:flex items-center justify-between flex-wrap gap-4 lg:gap-6 xl:gap-8">
                            <div class="flex items-center space-x-2 lg:space-x-3 flex-shrink-0">
                                <span class="text-sm text-gray-700 whitespace-nowrap">Show</span>
                                <select id="page-size-select" class="border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="10" selected>10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                <span class="text-sm text-gray-700 whitespace-nowrap">entries per page</span>
                            </div>
                            
                            <div class="flex items-center space-x-2 lg:space-x-3 flex-shrink-0">
                                <span id="pagination-info" class="text-sm text-gray-700 whitespace-nowrap">
                                    Showing <span id="start-entry">1</span> to <span id="end-entry">10</span> of <span id="total-entries">0</span> entries
                                </span>
                            </div>
                            
                            <div class="flex items-center space-x-1 lg:space-x-2 flex-shrink-0">
                                <button id="prev-page" class="px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors whitespace-nowrap">
                                    Previous
                                </button>
                                <div id="page-numbers" class="flex items-center space-x-1 lg:space-x-2">
                                    <!-- Page numbers will be dynamically generated -->
                                </div>
                                <button id="next-page" class="px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors whitespace-nowrap">
                                    Next
                                </button>
                            </div>
                        </div>
                        
                        <!-- Mobile Layout -->
                        <div class="md:hidden space-y-3">
                            <div class="flex items-center justify-between flex-wrap gap-2">
                                <div class="flex items-center space-x-2 flex-shrink-0">
                                    <span class="text-sm text-gray-700 whitespace-nowrap">Show</span>
                                    <select id="page-size-select-mobile" class="border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="10" selected>10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                    <span class="text-sm text-gray-700 whitespace-nowrap">entries</span>
                                </div>
                                
                                <span id="pagination-info-mobile" class="text-sm text-gray-700 whitespace-nowrap">
                                    <span id="start-entry-mobile">1</span>-<span id="end-entry-mobile">10</span> of <span id="total-entries-mobile">0</span>
                                </span>
                            </div>
                            
                            <div class="flex items-center justify-between flex-wrap gap-2">
                                <button id="prev-page-mobile" class="px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors whitespace-nowrap">
                                    Previous
                                </button>
                                
                                <div id="page-numbers-mobile" class="flex items-center space-x-1">
                                    <!-- Page numbers will be dynamically generated -->
                                </div>
                                
                                <button id="next-page-mobile" class="px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors whitespace-nowrap">
                                    Next
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="empty-state" class="text-center py-12">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No members yet</h3>
                        <p class="text-gray-500 mb-4">Add members individually or upload a roster file to get started</p>
                    </div>
                </div>


            </div>
        </main>

        <!-- Similar Tools Section -->
        <section class="mt-16 mb-8">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Similar Tools & Initiatives</h2>
                <p class="text-lg text-gray-600 max-w-3xl mx-auto">Explore other interactive tools and resources from Rotaract South Asia MDIO</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl mx-auto">
                <!-- Rotaract Buddy -->
                <div class="group">
                    <a href="https://buddy.rsamdio.org/" target="_blank" rel="noopener noreferrer" 
                       class="block bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-200 hover:border-blue-300 transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
                        <div class="text-center">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-blue-800 mb-2">Rotaract Buddy</h3>
                            <p class="text-sm text-blue-600 mb-3">AI-powered chatbot for all your Rotary & Rotaract questions</p>
                            <div class="flex items-center justify-center text-blue-500 group-hover:text-blue-600 transition-colors duration-300">
                                <span class="text-sm font-medium">View Resource</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 group-hover:translate-x-1 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- NAVIGATE -->
                <div class="group">
                    <a href="https://navigate.rsamdio.org/" target="_blank" rel="noopener noreferrer" 
                       class="block bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-xl border border-green-200 hover:border-green-300 transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
                        <div class="text-center">
                            <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-green-800 mb-2">NAVIGATE</h3>
                            <p class="text-sm text-green-600 mb-3">Navigate your Rotaract journey with guided pathways</p>
                            <div class="flex items-center justify-center text-green-500 group-hover:text-green-600 transition-colors duration-300">
                                <span class="text-sm font-medium">View Resource</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 group-hover:translate-x-1 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Publications Hub -->
                <div class="group">
                    <a href="https://connect.rsamdio.org/publications" target="_blank" rel="noopener noreferrer" 
                       class="block bg-gradient-to-br from-purple-50 to-violet-50 p-6 rounded-xl border border-purple-200 hover:border-purple-300 transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
                        <div class="text-center">
                            <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-purple-800 mb-2">Publications Hub</h3>
                            <p class="text-sm text-purple-600 mb-3">Access the District Publications from across South Asia</p>
                            <div class="flex items-center justify-center text-purple-500 group-hover:text-purple-600 transition-colors duration-300">
                                <span class="text-sm font-medium">View Resource</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 group-hover:translate-x-1 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Rotaract News Entry Submission -->
                <div class="group">
                    <a href="https://connect.rsamdio.org/rotaractnews" target="_blank" rel="noopener noreferrer" 
                       class="block bg-gradient-to-br from-orange-50 to-red-50 p-6 rounded-xl border border-orange-200 hover:border-orange-300 transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
                        <div class="text-center">
                            <div class="w-12 h-12 bg-gradient-to-r from-orange-500 to-orange-600 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-orange-800 mb-2">News Submission</h3>
                            <p class="text-sm text-orange-600 mb-3">Submit your updates for the official Rotaract News Magazine</p>
                            <div class="flex items-center justify-center text-orange-500 group-hover:text-orange-600 transition-colors duration-300">
                                <span class="text-sm font-medium">View Resource</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 group-hover:translate-x-1 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </section>



        <footer class="mt-12 py-6 bg-gradient-to-br from-gray-25 to-gray-50 border-t border-gray-100">
            <div class="max-w-5xl mx-auto px-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-6">
                    <!-- Copyright & Organization -->
                    <div class="text-center md:text-left">
                        <h4 class="text-sm font-medium text-gray-500 mb-2">Rotaract South Asia MDIO</h4>
                        <p class="text-xs text-gray-400"> <span id="current-year"></span> All rights reserved.</p>
                    </div>

                    <!-- Contact Information -->
                    <div class="text-center">
                        <h4 class="text-sm font-medium text-gray-500 mb-2">Contact</h4>
                        <p class="text-xs text-gray-400 mb-1">PDRR Arun Teja Godavarthi</p>
                        <a href="mailto:rotaract3191drr@gmail.com" class="text-xs text-blue-500 hover:text-blue-600 transition-colors font-medium hover:underline">
                            rotaract3191drr@gmail.com
                        </a>
                    </div>

                    <!-- Disclaimer -->
                    <div class="text-center md:text-right">
                        <h4 class="text-sm font-medium text-gray-500 mb-2">Disclaimer</h4>
                        <p class="text-xs text-gray-400">All calculations are indicative estimates. Actual figures may vary based on various factors.</p>
                    </div>
                </div>

                <!-- Bottom Bar -->
                <div class="border-t border-gray-200 pt-4">
                    <div class="flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0">
                        <p class="text-xs text-gray-400 text-center sm:text-left">This tool is designed to help Rotaractors estimate their Club Invoice calculations efficiently and accurately.</p>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-400">Powered by</span>
                            <a href="https://rtr.zeospec.com/" target="_blank" rel="noopener noreferrer" class="text-xs font-medium text-gray-500 hover:text-gray-600 transition-colors">ZeoSpec</a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>

    </div>

    <script>
        // Performance optimization: Use requestIdleCallback for non-critical operations
        const requestIdleCallback = window.requestIdleCallback || ((cb) => setTimeout(cb, 1));
        
        document.addEventListener('DOMContentLoaded', () => {
            // Hide loading overlay
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('active');
            }
            const addMemberForm = document.getElementById('add-member-form');
            const memberNameInput = document.getElementById('member-name');
            const memberTypeInput = document.getElementById('member-type');
            const joinDateInput = document.getElementById('join-date');
            const leaveDateInput = document.getElementById('leave-date');
            const memberRosterBody = document.getElementById('member-roster-body');
            const totalInvoiceAmountEl = document.getElementById('total-invoice-amount');
            const resetButton = document.getElementById('reset-button');
            const invoiceYearSelect = document.getElementById('invoice-year-select');
            const invoiceDateDisplay = document.getElementById('invoice-date-display');
            const currentYearSpan = document.getElementById('current-year');
            const taxPercentageInput = document.getElementById('tax-percentage');
            const baseInvoiceAmountEl = document.getElementById('base-invoice-amount');
            const taxBreakdownEl = document.getElementById('tax-breakdown');

            // Bulk upload elements
            const fileUploadArea = document.getElementById('file-upload-area');
            const fileInput = document.getElementById('file-input');
            const browseButton = document.getElementById('browse-button');
            const uploadPreview = document.getElementById('upload-preview');
            const previewContent = document.getElementById('preview-content');
            const confirmUpload = document.getElementById('confirm-upload');
            const cancelUpload = document.getElementById('cancel-upload');
            const downloadTemplate = document.getElementById('download-template');

            let parsedMembers = [];

            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayFormatted = `${yyyy}-${mm}-${dd}`;
            joinDateInput.value = todayFormatted;
            currentYearSpan.textContent = yyyy;

            let lastSelectedClubBase = memberTypeInput.value;
            let lastSelectedJoinDate = joinDateInput.value;

            // Pagination variables
            let currentPage = 1;
            let pageSize = 10;
            let allMemberRows = [];

            // Bulk Upload Functions
            function downloadCSVTemplate() {
                const csvContent = 'Member Name,Join Date,Club Base,Leave Date\nJohn Doe,2024-01-01,Community-Based,\nJane Smith,2024-02-01,University-Based,2024-12-31';
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Member Roster Template.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            function parseExcelFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            // Remove header row and process data
                            const processedData = jsonData.slice(1).filter(row => row.length >= 3);
                            resolve(processedData);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            function parseCSVFile(file) {
                return new Promise((resolve, reject) => {
                    Papa.parse(file, {
                        complete: function(results) {
                            if (results.errors.length > 0) {
                                reject(new Error('CSV parsing error: ' + results.errors[0].message));
                                return;
                            }
                            // Remove header row and process data
                            const processedData = results.data.slice(1).filter(row => row.length >= 3);
                            resolve(processedData);
                        },
                        error: function(error) {
                            reject(error);
                        }
                    });
                });
            }

            function validateMemberData(data) {
                const validatedMembers = [];
                const errors = [];

                data.forEach((row, index) => {
                    const [name, joinDate, memberType, leaveDate] = row;
                    
                    // Validate name
                    if (!name || typeof name !== 'string' || name.trim() === '') {
                        errors.push(`Row ${index + 2}: Invalid member name`);
                        return;
                    }

                    // Validate join date
                    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                    if (!joinDate || !dateRegex.test(joinDate)) {
                        errors.push(`Row ${index + 2}: Invalid join date format (use YYYY-MM-DD)`);
                        return;
                    }

                    // Validate club base
                    const validTypes = ['Community-Based', 'University-Based'];
                    if (!validTypes.includes(memberType)) {
                        errors.push(`Row ${index + 2}: Invalid Club Base (use "Community-Based" or "University-Based")`);
                        return;
                    }

                    // Validate leave date (optional)
                    if (leaveDate && leaveDate.trim() !== '' && !dateRegex.test(leaveDate)) {
                        errors.push(`Row ${index + 2}: Invalid leave date format (use YYYY-MM-DD or leave blank)`);
                        return;
                    }

                    validatedMembers.push({
                        name: name.trim(),
                        joinDate: joinDate,
                        clubBase: memberType,
                        leaveDate: leaveDate && leaveDate.trim() !== '' ? leaveDate : null
                    });
                });

                return { validatedMembers, errors };
            }

            function showPreview(members) {
                // Clear any existing file upload errors
                const errorContainer = document.getElementById('file-upload-error');
                if (errorContainer) {
                    errorContainer.classList.add('hidden');
                }
                
                // Clear any existing error timeout
                if (currentErrorTimeout) {
                    clearTimeout(currentErrorTimeout);
                    currentErrorTimeout = null;
                }
                
                const previewHTML = members.map((member, index) => {
                    const typeText = member.clubBase === 'Community-Based' ? 'Community-Based ($8)' : 'University-Based ($5)';
                    const leaveDateText = member.leaveDate ? ` | Left: ${member.leaveDate}` : '';
                    return `
                        <div class="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                            <div class="flex-1">
                                <span class="font-medium text-gray-800">${member.name}</span>
                                <span class="text-gray-500 ml-3">${member.joinDate}${leaveDateText}</span>
                                <span class="text-gray-500 ml-3">${typeText}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                previewContent.innerHTML = previewHTML;
                
                // Show the action buttons (Add to Roster and Cancel) - restore them if they were hidden
                const actionButtons = uploadPreview.querySelector('.flex.gap-3.mt-4');
                if (actionButtons) {
                    actionButtons.style.display = 'flex';
                }
                
                // Hide upload area with smooth transition
                fileUploadArea.classList.add('hidden');
                
                // Show preview after a short delay
                setTimeout(() => {
                    uploadPreview.classList.remove('hidden');
                }, 300);
            }

            function handleFileUpload(file) {
                // Show loading state
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('active');
                }
                
                const fileExtension = file.name.split('.').pop().toLowerCase();
                
                let parsePromise;
                if (fileExtension === 'csv') {
                    parsePromise = parseCSVFile(file);
                } else if (['xlsx', 'xls'].includes(fileExtension)) {
                    parsePromise = parseExcelFile(file);
                } else {
                    showFileUploadError('Unsupported file format. Please upload a CSV or Excel file.');
                    fileInput.value = ''; // Clear the file input so the same file can be selected again
                    return;
                }

                parsePromise.then(data => {
                    const validation = validateMemberData(data);
                    
                    if (validation.errors.length > 0) {
                        const errorMessage = 'Validation errors found:\n\n' + validation.errors.join('\n');
                        showFileUploadError(errorMessage);
                        fileInput.value = ''; // Clear the file input so the same file can be selected again
                        return;
                    }

                    parsedMembers = validation.validatedMembers;
                    showPreview(parsedMembers);
                }).catch(error => {
                    showFileUploadError('Error parsing file: ' + error.message);
                    fileInput.value = ''; // Clear the file input so the same file can be selected again
                }).finally(() => {
                    // Hide loading state
                    if (loadingOverlay) {
                        loadingOverlay.classList.remove('active');
                    }
                });
            }

            function addBulkMembers() {
                if (parsedMembers.length === 0) return;

                const selectedYear = parseInt(invoiceYearSelect.value, 10);
                
                parsedMembers.forEach(member => {
                    const duesBreakdown = calculateIndividualDue(member.joinDate, member.clubBase, selectedYear, member.leaveDate);
                    const memberId = `member-${Date.now()}-${Math.random()}`;
                    
                    const row = document.createElement('tr');
                    row.id = memberId;
                    row.dataset.due = duesBreakdown.total;
                    row.dataset.joinDate = member.joinDate;
                    row.dataset.leaveDate = member.leaveDate;
                    row.dataset.memberType = member.clubBase;
                    row.dataset.name = member.name;
                    row.classList.add('member-row');
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${member.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.joinDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.leaveDate || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.clubBase}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-medium due-cell">${formatDuesBreakdown(duesBreakdown)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${duesBreakdown.fullYear > 0 ? 'Yes' : 'No'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${duesBreakdown.proratedMonths || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="btn btn-secondary btn-sm !p-2 edit-member-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button class="btn btn-danger btn-sm !p-2 remove-member-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </td>
                    `;
                    
                    memberRosterBody.appendChild(row);

                    row.querySelector('.edit-member-btn').addEventListener('click', () => editMember(memberId));
                    row.querySelector('.remove-member-btn').addEventListener('click', () => {
                        row.remove();
                        updateTotal();
                        updatePagination();
                    });
                });

                updateTotal();
                updatePagination();
                
                // Show success animation and return to upload area
                showSuccessAnimation();
            }

            function resetBulkUpload() {
                parsedMembers = [];
                uploadPreview.classList.add('hidden');
                fileInput.value = '';
                
                // Clear any file upload errors
                const errorContainer = document.getElementById('file-upload-error');
                if (errorContainer) {
                    errorContainer.classList.add('hidden');
                }
                
                // Clear any existing error timeout
                if (currentErrorTimeout) {
                    clearTimeout(currentErrorTimeout);
                    currentErrorTimeout = null;
                }
                
                // Return to upload area after a short delay
                setTimeout(() => {
                    fileUploadArea.classList.remove('hidden');
                }, 300);
            }
            
            function showSuccessAnimation() {
                // Replace preview content with success message
                const successHTML = `
                    <div class="text-center py-8 success-animation">
                        <div class="success-icon mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Successfully Added!</h3>
                        <p class="text-gray-600 mb-4">${parsedMembers.length} member(s) have been added to your roster.</p>
                        <div class="flex gap-3 justify-center">
                            <button type="button" id="upload-more-btn" class="btn btn-primary text-sm px-6 py-3 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Upload More
                            </button>
                        </div>
                    </div>
                `;
                
                // Replace the entire preview content (including buttons)
                previewContent.innerHTML = successHTML;
                
                // Hide the action buttons (Add to Roster and Cancel)
                const actionButtons = uploadPreview.querySelector('.flex.gap-3.mt-4');
                if (actionButtons) {
                    actionButtons.style.display = 'none';
                }
                
                // Add event listener for upload more button
                document.getElementById('upload-more-btn').addEventListener('click', () => {
                    resetBulkUpload();
                });
                
                // Auto-return to upload area after 3 seconds
                setTimeout(() => {
                    resetBulkUpload();
                }, 3000);
            }

            function populateYearSelector() {
                const currentYear = new Date().getFullYear();
                const startInvoiceYear = 2023;
                const endInvoiceYear = currentYear + 25;
                for (let year = startInvoiceYear; year <= endInvoiceYear; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    invoiceYearSelect.appendChild(option);
                }
                invoiceYearSelect.value = currentYear + 1;
                updateInvoiceDateDisplay();
            }

            function updateInvoiceDateDisplay() {
                const selectedYear = invoiceYearSelect.value;
                if(invoiceDateDisplay) invoiceDateDisplay.textContent = `Jan 1st, ${selectedYear}`;
            }

            // Helper function for precise decimal arithmetic
            function preciseDecimal(value, decimals = 2) {
                return Math.round(value * Math.pow(10, decimals)) / Math.pow(10, decimals);
            }

            function formatDuesBreakdown(duesBreakdown) {
                const { fullYear, prorated, total } = duesBreakdown;
                
                if (total === 0) {
                    return '<span class="text-gray-400">$0.00</span>';
                }
                
                let breakdown = '';
                
                if (fullYear > 0 && prorated > 0) {
                    breakdown = `$${preciseDecimal(fullYear).toFixed(2)} + $${preciseDecimal(prorated).toFixed(2)} = $${preciseDecimal(total).toFixed(2)}`;
                } else if (fullYear > 0) {
                    breakdown = `$${preciseDecimal(fullYear).toFixed(2)} + $0.00 = $${preciseDecimal(total).toFixed(2)}`;
                } else if (prorated > 0) {
                    breakdown = `$0.00 + $${preciseDecimal(prorated).toFixed(2)} = $${preciseDecimal(total).toFixed(2)}`;
                }
                
                return breakdown;
            }

            function calculateIndividualDue(joinDateStr, clubBase, invoiceYear, leaveDateStr = null) {
                const joinDate = new Date(joinDateStr + 'T00:00:00');
                const invoiceDate = new Date(invoiceYear, 0, 1); // January 1st of invoice year
                const baseDues = clubBase === 'Community-Based' ? 8 : 5;
                const joinYear = joinDate.getFullYear();

                // If joined in the year immediately preceding the invoice year
                if (joinYear === invoiceYear - 1) {
                    const joinMonth = joinDate.getMonth();
                    const joinDay = joinDate.getDate();
                    
                    // Logic: If member joins on the 1st of the month or before, that month is counted
                    // If member joins after the 1st of the month, that month is not counted
                    let effectiveJoinMonth = joinMonth;
                    if (joinDay > 1) {
                        // If joined after the 1st, don't count that month
                        effectiveJoinMonth += 1;
                    }
                    
                    // Calculate prorated months for join year (even if joined in December)
                    const monthsInJoinYear = Math.max(0, 12 - effectiveJoinMonth);
                    let proratedDues = Math.round((baseDues / 12) * monthsInJoinYear * 100) / 100;

                    // Check if member left before invoice date
                    if (leaveDateStr) {
                        const leaveDate = new Date(leaveDateStr + 'T00:00:00');
                        if (leaveDate < invoiceDate) {
                            // Left before Jan 1st: charge only prorated dues for join year, but adjust for early departure
                            const leaveMonth = leaveDate.getMonth();
                            const leaveDay = leaveDate.getDate();
                            
                            // Logic for leave date: if they leave after the 1st, count that month
                            // If they leave on or before the 1st, don't count that month
                            let effectiveLeaveMonth = leaveMonth;
                            if (leaveDay > 1) {
                                effectiveLeaveMonth += 1;
                            }
                            
                            // Calculate actual months of membership in join year
                            // If leave month is before join month, no charge
                            if (effectiveLeaveMonth < effectiveJoinMonth) {
                                return { fullYear: 0, prorated: 0, total: 0, proratedMonths: 0 };
                            }
                            
                            // Calculate months based on effective join and leave months
                            let actualMonthsInJoinYear = effectiveLeaveMonth - effectiveJoinMonth;
                            
                            // Ensure months is not negative
                            actualMonthsInJoinYear = Math.max(0, actualMonthsInJoinYear);
                            proratedDues = Math.round((baseDues / 12) * actualMonthsInJoinYear * 100) / 100;
                            
                            return { fullYear: 0, prorated: proratedDues, total: proratedDues, proratedMonths: actualMonthsInJoinYear };
                        }
                    }
                    // Still a member on Jan 1st: charge both base fee and prorated fee
                    const total = Math.round((baseDues + proratedDues) * 100) / 100;
                    return { fullYear: baseDues, prorated: proratedDues, total: total, proratedMonths: monthsInJoinYear };
                }

                // If joined and left in the same year (not the year immediately preceding the invoice year), charge nothing
                if (joinYear >= invoiceYear) return { fullYear: 0, prorated: 0, total: 0, proratedMonths: 0 };

                // If left before Jan 1st, charge nothing
                if (leaveDateStr) {
                    const leaveDate = new Date(leaveDateStr + 'T00:00:00');
                    if (leaveDate < invoiceDate) return { fullYear: 0, prorated: 0, total: 0, proratedMonths: 0 };
                }

                if (joinYear < invoiceYear - 1) return { fullYear: baseDues, prorated: 0, total: baseDues, proratedMonths: 0 };
                return { fullYear: 0, prorated: 0, total: 0, proratedMonths: 0 };
            }

            // Debounced function for performance optimization
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            function updateTotal() {
                // Use requestIdleCallback for non-critical updates
                requestIdleCallback(() => {
                    let baseTotal = 0;
                    let totalFullYear = 0;
                    let totalProrated = 0;
                    let totalMembersWithFullYear = 0;
                    let totalProratedMonths = 0;
                    const selectedYear = parseInt(invoiceYearSelect.value, 10);
                    const memberRows = memberRosterBody.querySelectorAll('tr');
                    
                    memberRows.forEach(row => {
                        const joinDate = row.dataset.joinDate;
                        const leaveDate = row.dataset.leaveDate;
                        const memberType = row.dataset.memberType;
                        const duesBreakdown = calculateIndividualDue(joinDate, memberType, selectedYear, leaveDate);
                        
                        baseTotal += duesBreakdown.total;
                        totalFullYear += duesBreakdown.fullYear;
                        totalProrated += duesBreakdown.prorated;
                        
                        // Count members with full year dues
                        if (duesBreakdown.fullYear > 0) {
                            totalMembersWithFullYear++;
                        }
                        
                        // Add prorated months directly from the calculation
                        totalProratedMonths += duesBreakdown.proratedMonths || 0;
                    });
                    
                    // Calculate tax with precise arithmetic
                    const taxPercentage = parseFloat(taxPercentageInput.value) || 0;
                    const taxAmount = Math.round((baseTotal * taxPercentage) / 100 * 100) / 100;
                    const totalWithTax = Math.round((baseTotal + taxAmount) * 100) / 100;
                    
                    // Update display with animation and precise formatting
                    baseInvoiceAmountEl.textContent = `$${Math.round(baseTotal * 100) / 100}`;
                    totalInvoiceAmountEl.textContent = `$${Math.round(totalWithTax * 100) / 100}`;
                    taxBreakdownEl.textContent = `Tax: $${Math.round(taxAmount * 100) / 100} (${taxPercentage}%)`;
                    
                    // Update dues breakdown with precise arithmetic
                    const duesBreakdownEl = document.getElementById('dues-breakdown');
                    if (duesBreakdownEl) {
                        const preciseFullYear = Math.round(totalFullYear * 100) / 100;
                        const preciseProrated = Math.round(totalProrated * 100) / 100;
                        duesBreakdownEl.textContent = `Full Year: $${preciseFullYear.toFixed(2)} + Prorated: $${preciseProrated.toFixed(2)}`;
                    }
                    
                    // Update new summary data
                    const totalMembersEl = document.getElementById('total-members');
                    const totalProratedMonthsEl = document.getElementById('total-prorated-months');
                    
                    if (totalMembersEl) {
                        totalMembersEl.textContent = totalMembersWithFullYear;
                    }
                    if (totalProratedMonthsEl) {
                        totalProratedMonthsEl.textContent = totalProratedMonths;
                    }
                    
                    // Show/hide empty state
                    const emptyState = document.getElementById('empty-state');
                    if (memberRows.length === 0) {
                        emptyState.classList.remove('hidden');
                    } else {
                        emptyState.classList.add('hidden');
                    }
                });
            }
            
            // Debounced version for input events
            const debouncedUpdateTotal = debounce(updateTotal, 300);
            
            function recalculateAllDues() {
                const selectedYear = parseInt(invoiceYearSelect.value, 10);
                const memberRows = memberRosterBody.querySelectorAll('tr');
                memberRows.forEach(row => {
                    if (row.classList.contains('editing')) return; // Skip editing rows
                    const joinDate = row.dataset.joinDate;
                    const leaveDate = row.dataset.leaveDate;
                    const memberType = row.dataset.memberType;
                    const duesBreakdown = calculateIndividualDue(joinDate, memberType, selectedYear, leaveDate);
                    row.dataset.due = duesBreakdown.total;
                    row.querySelector('.due-cell').innerHTML = formatDuesBreakdown(duesBreakdown);
                    
                    // Update the new columns
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 7) {
                        cells[5].textContent = duesBreakdown.fullYear > 0 ? 'Yes' : 'No';
                        cells[6].textContent = duesBreakdown.proratedMonths || 0;
                    }
                });
                updateTotal();
                updateInvoiceDateDisplay();
            }

            // Unified Form Validation System
            class FormValidator {
                constructor() {
                    this.errors = new Map();
                    this.validationRules = {
                        'member-name': [
                            { test: (value) => value.trim().length > 0, message: 'Member name is required' },
                            { test: (value) => value.trim().length >= 2, message: 'Name must be at least 2 characters' },
                            { test: (value) => /^[a-zA-Z\s]+$/.test(value.trim()), message: 'Name should only contain letters and spaces' }
                        ],
                        'member-type': [
                            { test: (value) => value.length > 0, message: 'Please select a Club Base' }
                        ],
                        'join-date': [
                            { test: (value) => value.length > 0, message: 'Join date is required' },
                            { test: (value) => this.isValidDate(value), message: 'Please enter a valid date' }
                        ],
                        'leave-date': [
                            { test: (value) => !value || this.isValidDate(value), message: 'Please enter a valid date' },
                            { test: (value) => !value || this.isLeaveDateValid(value), message: 'Leave date cannot be before join date' }
                        ]
                    };
                }

                isValidDate(dateString) {
                    const date = new Date(dateString);
                    return date instanceof Date && !isNaN(date);
                }

                isLeaveDateValid(leaveDate) {
                    const joinDate = document.getElementById('join-date').value;
                    if (!joinDate) return true; // If no join date, leave date is valid
                    
                    const leaveDateObj = new Date(leaveDate);
                    const joinDateObj = new Date(joinDate);
                    return leaveDateObj >= joinDateObj;
                }

                validateField(fieldId) {
                    const field = document.getElementById(fieldId);
                    if (!field || !this.validationRules[fieldId]) return true;

                    const value = field.value;
                    const rules = this.validationRules[fieldId];
                    
                    // Clear previous error for this field
                    this.clearFieldError(fieldId);
                    
                    // Check each validation rule
                    for (const rule of rules) {
                        if (!rule.test(value)) {
                            this.setFieldError(fieldId, rule.message);
                            return false;
                        }
                    }
                    
                    // If we get here, field is valid
                    this.setFieldSuccess(fieldId);
                    return true;
                }

                validateAll() {
                    this.clearAllErrors();
                    
                    let isValid = true;
                    const fieldIds = Object.keys(this.validationRules);
                    
                    for (const fieldId of fieldIds) {
                        if (!this.validateField(fieldId)) {
                            isValid = false;
                        }
                    }
                    
                    return isValid;
                }

                setFieldError(fieldId, message) {
                    const field = document.getElementById(fieldId);
                    const errorElement = document.getElementById(`${fieldId}-error`);
                    
                    if (field && errorElement) {
                        field.classList.remove('input-success');
                        field.classList.add('input-error');
                        errorElement.textContent = message;
                        errorElement.style.display = 'block';
                        
                        // Add error to our tracking
                        this.errors.set(fieldId, message);
                    }
                }

                setFieldSuccess(fieldId) {
                    const field = document.getElementById(fieldId);
                    const errorElement = document.getElementById(`${fieldId}-error`);
                    
                    if (field && errorElement) {
                        field.classList.remove('input-error');
                        field.classList.add('input-success');
                        errorElement.style.display = 'none';
                        errorElement.textContent = '';
                        
                        // Remove error from our tracking
                        this.errors.delete(fieldId);
                    }
                }

                clearFieldError(fieldId) {
                    const field = document.getElementById(fieldId);
                    const errorElement = document.getElementById(`${fieldId}-error`);
                    
                    if (field && errorElement) {
                        field.classList.remove('input-error', 'input-success');
                        errorElement.style.display = 'none';
                        errorElement.textContent = '';
                        
                        // Remove error from our tracking
                        this.errors.delete(fieldId);
                    }
                }

                clearAllErrors() {
                    document.querySelectorAll('.error-message').forEach(el => {
                        el.style.display = 'none';
                        el.textContent = '';
                    });
                    document.querySelectorAll('.input-error, .input-success').forEach(el => {
                        el.classList.remove('input-error', 'input-success');
                    });
                    this.errors.clear();
                }

                getFirstError() {
                    return this.errors.size > 0 ? this.errors.values().next().value : null;
                }

                hasErrors() {
                    return this.errors.size > 0;
                }
            }

            // Initialize form validator
            const formValidator = new FormValidator();
            
            // Legacy function for backward compatibility (now uses the new system)
            function showFieldError(fieldId, message, shouldFocus = false) {
                formValidator.setFieldError(fieldId, message);
                if (shouldFocus) {
                    const field = document.getElementById(fieldId);
                    if (field) field.focus();
                }
            }
            
            function showSuccessMessage(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success-feedback fade-in';
                successDiv.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>${message}</span>
                `;
                
                // Insert after the form
                addMemberForm.parentNode.insertBefore(successDiv, addMemberForm.nextSibling);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
            }
            
            function showErrorMessage(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-feedback fade-in';
                errorDiv.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>${message}</span>
                `;
                
                // Insert after the form
                addMemberForm.parentNode.insertBefore(errorDiv, addMemberForm.nextSibling);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
            
            // Global variable to track the current error timeout
            let currentErrorTimeout = null;
            
            function showFileUploadError(message) {
                const errorContainer = document.getElementById('file-upload-error');
                if (!errorContainer) return;
                
                // Clear any existing timeout to prevent conflicts
                if (currentErrorTimeout) {
                    clearTimeout(currentErrorTimeout);
                    currentErrorTimeout = null;
                }
                
                // Ensure the container is visible and properly styled
                errorContainer.className = 'error-feedback fade-in mb-4';
                errorContainer.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>${message}</span>
                `;
                errorContainer.classList.remove('hidden');
                
                // Set new timeout and store the reference
                currentErrorTimeout = setTimeout(() => {
                    errorContainer.classList.add('hidden');
                    currentErrorTimeout = null;
                }, 4000);
            }
            
            function addMember(e) {
                // e.preventDefault() is now handled in the event listener
                
                // Use the new unified validation system
                if (!formValidator.validateAll()) {
                    // Show a summary error message if there are multiple errors
                    if (formValidator.errors.size > 1) {
                        showErrorMessage(`Please fix ${formValidator.errors.size} validation errors before submitting.`);
                    }
                    return;
                }
                
                const name = memberNameInput.value.trim();
                const clubBase = memberTypeInput.value;
                const joinDate = joinDateInput.value;
                const leaveDate = leaveDateInput.value;

                const selectedYear = parseInt(invoiceYearSelect.value, 10);
                const duesBreakdown = calculateIndividualDue(joinDate, clubBase, selectedYear, leaveDate);
                const memberId = `member-${Date.now()}`;
                const row = document.createElement('tr');
                row.id = memberId;
                row.dataset.due = duesBreakdown.total;
                row.dataset.joinDate = joinDate;
                row.dataset.leaveDate = leaveDate;
                row.dataset.memberType = clubBase;
                row.dataset.name = name;
                row.classList.add('member-row');
                
                                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${joinDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${leaveDate || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${clubBase}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-medium due-cell">${formatDuesBreakdown(duesBreakdown)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${duesBreakdown.fullYear > 0 ? 'Yes' : 'No'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${duesBreakdown.proratedMonths || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="btn btn-secondary btn-sm !p-2 edit-member-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button class="btn btn-danger btn-sm !p-2 remove-member-btn">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                `;
                memberRosterBody.appendChild(row);

                row.querySelector('.edit-member-btn').addEventListener('click', () => editMember(memberId));
                row.querySelector('.remove-member-btn').addEventListener('click', () => {
                    row.remove();
                    updateTotal();
                    updatePagination();
                });
                
                lastSelectedClubBase = clubBase;
                lastSelectedJoinDate = joinDate;
                updateTotal();
                updatePagination();
                
                // Clear all validation states before resetting
                formValidator.clearAllErrors();
                
                addMemberForm.reset();
                joinDateInput.value = lastSelectedJoinDate;
                memberTypeInput.value = lastSelectedClubBase;
                
                // Show success message
                showSuccessMessage('Member added successfully!');
                
                // Add success animation to the new row
                row.classList.add('slide-up');
            }

            function editMember(memberId) {
                const row = document.getElementById(memberId);
                if (!row || row.classList.contains('editing')) return;

                document.querySelectorAll('.edit-member-btn').forEach(btn => btn.disabled = true);
                row.classList.add('editing');

                const name = row.dataset.name;
                const joinDate = row.dataset.joinDate;
                const leaveDate = row.dataset.leaveDate;
                const memberType = row.dataset.memberType;

                // Enhanced input fields with better styling and visibility
                row.cells[0].innerHTML = `<input type="text" value="${name}" class="edit-mode-input" placeholder="Enter member name">`;
                row.cells[1].innerHTML = `<input type="date" value="${joinDate}" class="edit-mode-input">`;
                row.cells[2].innerHTML = `<input type="date" value="${leaveDate || ''}" class="edit-mode-input" placeholder="Leave date (optional)">`;
                row.cells[3].innerHTML = `
                    <select class="edit-mode-select">
                        <option value="Community-Based" ${memberType === 'Community-Based' ? 'selected' : ''}>Community-Based ($8)</option>
                        <option value="University-Based" ${memberType === 'University-Based' ? 'selected' : ''}>University-Based ($5)</option>
                    </select>
                `;
                row.cells[4].innerHTML = '<span class="text-gray-400 italic">Calculating...</span>';
                row.cells[5].innerHTML = '<span class="text-gray-400 italic">Calculating...</span>';
                row.cells[6].innerHTML = '<span class="text-gray-400 italic">Calculating...</span>';
                row.cells[7].innerHTML = `
                    <div class="flex space-x-2">
                        <button class="btn btn-primary btn-sm !p-2 save-member-btn" title="Save changes">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                        <button class="btn btn-secondary btn-sm !p-2 cancel-edit-btn" title="Cancel editing">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `;

                // Add event listeners
                row.querySelector('.save-member-btn').addEventListener('click', () => saveMember(memberId));
                row.querySelector('.cancel-edit-btn').addEventListener('click', () => cancelEdit(memberId));
                
                // Auto-focus on the name input for better UX
                setTimeout(() => {
                    const nameInput = row.cells[0].querySelector('input');
                    if (nameInput) {
                        nameInput.focus();
                        nameInput.select();
                    }
                }, 100);
                
                // Add keyboard support for better UX
                const inputs = row.querySelectorAll('input, select');
                inputs.forEach((input, index) => {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            if (index < inputs.length - 1) {
                                inputs[index + 1].focus();
                            } else {
                                saveMember(memberId);
                            }
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            cancelEdit(memberId);
                        }
                    });
                });
            }

            function saveMember(memberId) {
                const row = document.getElementById(memberId);
                if (!row) return;

                const newName = row.cells[0].querySelector('input').value.trim();
                const newJoinDate = row.cells[1].querySelector('input').value;
                const newLeaveDate = row.cells[2].querySelector('input').value;
                const newMemberType = row.cells[3].querySelector('select').value;

                // Enhanced validation for edit mode
                if (!newName) {
                    showErrorMessage('Please enter a member name');
                    row.cells[0].querySelector('input').focus();
                    return;
                }

                if (!newJoinDate) {
                    showErrorMessage('Please select a join date');
                    row.cells[1].querySelector('input').focus();
                    return;
                }

                row.dataset.name = newName;
                row.dataset.joinDate = newJoinDate;
                row.dataset.leaveDate = newLeaveDate;
                row.dataset.memberType = newMemberType;

                const selectedYear = parseInt(invoiceYearSelect.value, 10);
                const duesBreakdown = calculateIndividualDue(newJoinDate, newMemberType, selectedYear, newLeaveDate);
                row.dataset.due = duesBreakdown.total;

                row.cells[0].textContent = newName;
                row.cells[1].textContent = newJoinDate;
                row.cells[2].textContent = newLeaveDate || '-';
                row.cells[3].textContent = newMemberType;
                row.cells[4].innerHTML = formatDuesBreakdown(duesBreakdown);
                row.cells[4].classList.add('due-cell');
                row.cells[5].textContent = duesBreakdown.fullYear > 0 ? 'Yes' : 'No';
                row.cells[6].textContent = duesBreakdown.proratedMonths || 0;
                
                finishEditing(row, memberId);
                recalculateAllDues();
                
                // Show success feedback
                row.style.backgroundColor = '#f0f9ff';
                setTimeout(() => {
                    row.style.backgroundColor = '';
                }, 1000);
            }

            function cancelEdit(memberId) {
                const row = document.getElementById(memberId);
                if (!row) return;

                const name = row.dataset.name;
                const joinDate = row.dataset.joinDate;
                const leaveDate = row.dataset.leaveDate;
                const memberType = row.dataset.memberType;
                const selectedYear = parseInt(invoiceYearSelect.value, 10);
                const duesBreakdown = calculateIndividualDue(joinDate, memberType, selectedYear, leaveDate);

                row.cells[0].textContent = name;
                row.cells[1].textContent = joinDate;
                row.cells[2].textContent = leaveDate || '-';
                row.cells[3].textContent = memberType;
                row.cells[4].innerHTML = formatDuesBreakdown(duesBreakdown);
                row.cells[4].classList.add('due-cell');
                row.cells[5].textContent = duesBreakdown.fullYear > 0 ? 'Yes' : 'No';
                row.cells[6].textContent = duesBreakdown.proratedMonths || 0;

                finishEditing(row, memberId);
            }

            function finishEditing(row, memberId) {
                row.classList.remove('editing');
                row.cells[7].innerHTML = `
                    <button class="btn btn-secondary btn-sm !p-2 edit-member-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button class="btn btn-danger btn-sm !p-2 remove-member-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                `;
                row.querySelector('.edit-member-btn').addEventListener('click', () => editMember(memberId));
                row.querySelector('.remove-member-btn').addEventListener('click', () => {
                    row.remove();
                    updateTotal();
                });
                document.querySelectorAll('.edit-member-btn').forEach(btn => btn.disabled = false);
            }
            
            function resetCalculator() {
                memberRosterBody.innerHTML = '';
                allMemberRows = [];
                currentPage = 1;
                updateTotal();
                updatePagination();
            }

            // Pagination Functions
            function updatePagination() {
                const paginationControls = document.getElementById('pagination-controls');
                const pageSizeSelect = document.getElementById('page-size-select');
                const pageSizeSelectMobile = document.getElementById('page-size-select-mobile');
                const prevPageBtn = document.getElementById('prev-page');
                const nextPageBtn = document.getElementById('next-page');
                const prevPageBtnMobile = document.getElementById('prev-page-mobile');
                const nextPageBtnMobile = document.getElementById('next-page-mobile');
                const pageNumbers = document.getElementById('page-numbers');
                const pageNumbersMobile = document.getElementById('page-numbers-mobile');
                const startEntry = document.getElementById('start-entry');
                const endEntry = document.getElementById('end-entry');
                const totalEntries = document.getElementById('total-entries');
                const startEntryMobile = document.getElementById('start-entry-mobile');
                const endEntryMobile = document.getElementById('end-entry-mobile');
                const totalEntriesMobile = document.getElementById('total-entries-mobile');

                // Get all member rows
                allMemberRows = Array.from(memberRosterBody.querySelectorAll('tr.member-row'));
                
                const totalMembers = allMemberRows.length;
                const totalPages = Math.ceil(totalMembers / pageSize);
                
                // Show/hide pagination controls
                if (totalMembers > pageSize) {
                    paginationControls.classList.remove('hidden');
                } else {
                    paginationControls.classList.add('hidden');
                }
                
                // Update pagination info
                const start = (currentPage - 1) * pageSize + 1;
                const end = Math.min(currentPage * pageSize, totalMembers);
                
                startEntry.textContent = totalMembers > 0 ? start : 0;
                endEntry.textContent = end;
                totalEntries.textContent = totalMembers;
                
                // Update mobile pagination info
                if (startEntryMobile) startEntryMobile.textContent = totalMembers > 0 ? start : 0;
                if (endEntryMobile) endEntryMobile.textContent = end;
                if (totalEntriesMobile) totalEntriesMobile.textContent = totalMembers;
                
                // Update page size selectors
                pageSizeSelect.value = pageSize;
                if (pageSizeSelectMobile) pageSizeSelectMobile.value = pageSize;
                
                // Update navigation buttons
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
                
                // Update mobile navigation buttons
                if (prevPageBtnMobile) prevPageBtnMobile.disabled = currentPage === 1;
                if (nextPageBtnMobile) nextPageBtnMobile.disabled = currentPage === totalPages;
                
                // Generate page numbers
                pageNumbers.innerHTML = '';
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `px-3 py-1 text-sm border rounded-md transition-colors whitespace-nowrap min-w-[2rem] ${
                        i === currentPage 
                            ? 'bg-blue-500 text-white border-blue-500' 
                            : 'border-gray-300 hover:bg-gray-50'
                    }`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => goToPage(i));
                    pageNumbers.appendChild(pageBtn);
                }
                
                // Generate mobile page numbers (show fewer pages on mobile)
                if (pageNumbersMobile) {
                    pageNumbersMobile.innerHTML = '';
                    const maxVisiblePagesMobile = 3; // Show fewer pages on mobile
                    let startPageMobile = Math.max(1, currentPage - Math.floor(maxVisiblePagesMobile / 2));
                    let endPageMobile = Math.min(totalPages, startPageMobile + maxVisiblePagesMobile - 1);
                    
                    if (endPageMobile - startPageMobile + 1 < maxVisiblePagesMobile) {
                        startPageMobile = Math.max(1, endPageMobile - maxVisiblePagesMobile + 1);
                    }
                    
                    for (let i = startPageMobile; i <= endPageMobile; i++) {
                        const pageBtnMobile = document.createElement('button');
                        pageBtnMobile.className = `px-2 py-1 text-xs border rounded transition-colors whitespace-nowrap min-w-[1.5rem] ${
                            i === currentPage 
                                ? 'bg-blue-500 text-white border-blue-500' 
                                : 'border-gray-300 hover:bg-gray-50'
                        }`;
                        pageBtnMobile.textContent = i;
                        pageBtnMobile.addEventListener('click', () => goToPage(i));
                        pageNumbersMobile.appendChild(pageBtnMobile);
                    }
                }
                
                // Show current page rows
                displayCurrentPage();
            }
            
            function displayCurrentPage() {
                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                
                // Hide all rows
                allMemberRows.forEach(row => {
                    row.style.display = 'none';
                });
                
                // Show only current page rows
                allMemberRows.slice(start, end).forEach(row => {
                    row.style.display = '';
                });
            }
            
            function goToPage(page) {
                currentPage = page;
                displayCurrentPage();
                updatePagination();
            }
            
            function goToPreviousPage() {
                if (currentPage > 1) {
                    goToPage(currentPage - 1);
                }
            }
            
            function goToNextPage() {
                const totalPages = Math.ceil(allMemberRows.length / pageSize);
                if (currentPage < totalPages) {
                    goToPage(currentPage + 1);
                }
            }
            
            function changePageSize(newSize) {
                pageSize = parseInt(newSize);
                currentPage = 1; // Reset to first page
                updatePagination();
            }

            addMemberForm.addEventListener('submit', (e) => {
                e.preventDefault(); // Prevent default HTML5 validation
                addMember(e);
            });
            resetButton.addEventListener('click', resetCalculator);
            invoiceYearSelect.addEventListener('change', recalculateAllDues);
            taxPercentageInput.addEventListener('input', debouncedUpdateTotal);

            // Bulk upload event listeners
            browseButton.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });

            // Drag and drop functionality
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });

            confirmUpload.addEventListener('click', addBulkMembers);
            cancelUpload.addEventListener('click', resetBulkUpload);
            downloadTemplate.addEventListener('click', downloadCSVTemplate);

            // Pagination event listeners
            const pageSizeSelect = document.getElementById('page-size-select');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            
            pageSizeSelect.addEventListener('change', (e) => changePageSize(e.target.value));
            prevPageBtn.addEventListener('click', goToPreviousPage);
            nextPageBtn.addEventListener('click', goToNextPage);

            // Mobile pagination event listeners
            const pageSizeSelectMobile = document.getElementById('page-size-select-mobile');
            const prevPageBtnMobile = document.getElementById('prev-page-mobile');
            const nextPageBtnMobile = document.getElementById('next-page-mobile');
            
            if (pageSizeSelectMobile) {
                pageSizeSelectMobile.addEventListener('change', (e) => changePageSize(e.target.value));
            }
            if (prevPageBtnMobile) {
                prevPageBtnMobile.addEventListener('click', goToPreviousPage);
            }
            if (nextPageBtnMobile) {
                nextPageBtnMobile.addEventListener('click', goToNextPage);
            }

            // Initialize the application
            populateYearSelector();
            updatePagination();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Enter to add member
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.closest('#add-member-form')) {
                        addMemberForm.dispatchEvent(new Event('submit'));
                    }
                }
                
                // Escape to close modals/overlays
                if (e.key === 'Escape') {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay && loadingOverlay.classList.contains('active')) {
                        loadingOverlay.classList.remove('active');
                    }
                }
            });
            
            // Add form field validation on blur using the new system
            [memberNameInput, memberTypeInput, joinDateInput, leaveDateInput].forEach(input => {
                if (input) {
                    input.addEventListener('blur', () => {
                        // Validate only the specific field that lost focus
                        formValidator.validateField(input.id);
                    });
                    
                    // Add real-time validation on input for better UX
                    input.addEventListener('input', () => {
                        // Clear error state when user starts typing/selecting
                        if (formValidator.errors.has(input.id)) {
                            formValidator.clearFieldError(input.id);
                        }
                    });
                }
            });
            
            // Performance optimization: Preload critical resources
            requestIdleCallback(() => {
                // Preload any additional resources if needed
                // Application loaded successfully
            });

            // PDF Generation Functionality using Web Worker
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            const pdfStatus = document.getElementById('pdfStatus');
            let pdfWorker = null;

            downloadPdfBtn.addEventListener('click', function(event) {
                // Prevent default form submission behavior
                event.preventDefault();
                event.stopPropagation();
                
                // Log current member count for debugging
                const memberCount = document.getElementById('member-roster-body').querySelectorAll('tr').length;
                console.log('PDF Generation started. Current member count:', memberCount);
                
                generatePDFReport();
            });

            function generatePDFReport() {
                // Show loading overlay for better UX
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('active');
                }
                
                // Show loading status
                downloadPdfBtn.disabled = true;
                pdfStatus.classList.remove('hidden');
                
                // Use setTimeout to allow UI to update before starting heavy processing
                setTimeout(() => {
                    generatePDFReportAsync();
                }, 100);
            }

            async function generatePDFReportAsync() {
                try {
                    // Update loading message for better UX
                    const loadingMessage = document.getElementById('loading-message');
                    const progressBar = document.getElementById('loading-progress-bar');
                    const step1 = document.getElementById('step-1');
                    const step2 = document.getElementById('step-2');
                    const step3 = document.getElementById('step-3');
                    const step4 = document.getElementById('step-4');
                    
                    if (loadingMessage) {
                        loadingMessage.textContent = 'Preparing PDF report...';
                    }
                    if (progressBar) {
                        progressBar.style.width = '10%';
                    }
                    
                    // Get summary data from the existing calculations
                    const baseAmount = parseFloat(document.getElementById('base-invoice-amount').textContent.replace(/[^0-9.-]+/g, '')) || 0;
                    const taxAmount = parseFloat(document.getElementById('tax-breakdown').textContent.replace(/[^0-9.-]+/g, '')) || 0;
                    const totalAmount = parseFloat(document.getElementById('total-invoice-amount').textContent.replace(/[^0-9.-]+/g, '')) || 0;
                    const totalMembers = document.getElementById('total-members').textContent || '0';
                    const totalProratedMonths = document.getElementById('total-prorated-months').textContent || '0';
                    const taxPercentage = document.getElementById('tax-percentage').value || '0';
                    const invoiceYear = document.getElementById('invoice-year-select').value;

                    // Extract Full Year and Prorated amounts from the base amount breakdown
                    let totalFullYearAmount = 0;
                    let totalProratedAmount = 0;
                    
                    // Use the existing calculated values from member roster cells
                    const memberRowsForSummary = document.getElementById('member-roster-body').querySelectorAll('tr');
                    memberRowsForSummary.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 7) {
                            const estBaseDue = cells[4].textContent.trim();
                            const dueMatch = estBaseDue.match(/\$([0-9,]+\.?[0-9]*) \+ \$([0-9,]+\.?[0-9]*) = \$([0-9,]+\.?[0-9]*)/);
                            if (dueMatch) {
                                const fullYearAmount = parseFloat(dueMatch[1].replace(/,/g, '')) || 0;
                                const proratedAmount = parseFloat(dueMatch[2].replace(/,/g, '')) || 0;
                                
                                totalFullYearAmount += fullYearAmount;
                                totalProratedAmount += proratedAmount;
                            }
                        }
                    });

                    // Prepare member data for PDF
                    const memberData = [];
                    const memberRows = document.getElementById('member-roster-body').querySelectorAll('tr');
                    
                    memberRows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 7) {
                            const name = cells[0].textContent.trim();
                            const joinDate = cells[1].textContent.trim();
                            const leaveDate = cells[2].textContent.trim() || 'Active';
                            const clubBase = cells[3].textContent.trim();
                            const estBaseDue = cells[4].textContent.trim();
                            const activeMember = cells[5].textContent.trim();
                            const proratedMonths = parseInt(cells[6].textContent.trim()) || 0;
                            
                            memberData.push([name, joinDate, leaveDate, clubBase, estBaseDue, activeMember, proratedMonths]);
                        }
                    });

                    // Add totals row
                    const formattedTotalFullYear = totalFullYearAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    const formattedTotalProrated = totalProratedAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    const formattedTotalEstDue = (totalFullYearAmount + totalProratedAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    
                    const totalEstDueDisplay = `${formattedTotalFullYear} + ${formattedTotalProrated} = ${formattedTotalEstDue}`;
                    
                    memberData.push([
                        'TOTAL',
                        '',
                        '',
                        '',
                        totalEstDueDisplay,
                        totalMembers,
                        totalProratedMonths
                    ]);

                    // Update loading progress
                    if (loadingMessage) {
                        loadingMessage.textContent = 'Generating PDF with Web Worker...';
                    }
                    if (progressBar) {
                        progressBar.style.width = '50%';
                    }
                    if (step1) {
                        step1.classList.remove('active');
                        step1.classList.add('completed');
                    }
                    if (step2) {
                        step2.classList.add('active');
                    }

                    // Prepare data for Web Worker
                    const pdfData = {
                        memberData: memberData,
                        summaryData: {
                            baseAmount: baseAmount,
                            taxAmount: taxAmount,
                            totalWithTax: totalAmount,
                            totalFullYearAmount: totalFullYearAmount,
                            totalProratedAmount: totalProratedAmount
                        },
                        invoiceYear: invoiceYear,
                        taxPercentage: taxPercentage,
                        totalMembers: totalMembers,
                        totalProratedMonths: totalProratedMonths
                    };

                    // Create Web Worker for PDF generation
                    if (!pdfWorker) {
                        try {
                            pdfWorker = new Worker('pdf-worker.js');
                            
                            // Handle Web Worker messages
                            pdfWorker.onmessage = function(e) {
                                const { type, blob, fileName, error } = e.data;
                                
                                if (type === 'pdfGenerated' && blob) {
                                    // Create download link and trigger download
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = fileName;
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    URL.revokeObjectURL(url);
                                    
                                    // Complete progress
                                    if (progressBar) {
                                        progressBar.style.width = '100%';
                                    }
                                    if (step4) {
                                        step4.classList.remove('active');
                                        step4.classList.add('completed');
                                    }
                                    if (loadingMessage) {
                                        loadingMessage.textContent = 'Detailed Report generated successfully!';
                                    }

                                    // Hide loading status and overlay after a brief delay
                                    setTimeout(() => {
                                        downloadPdfBtn.disabled = false;
                                        pdfStatus.classList.add('hidden');
                                        if (loadingOverlay) {
                                            loadingOverlay.classList.remove('active');
                                        }
                                    }, 1000);
                                    
                                } else if (type === 'error') {
                                    console.error('PDF generation error:', error);
                                    
                                    // Hide loading status and overlay
                                    downloadPdfBtn.disabled = false;
                                    pdfStatus.classList.add('hidden');
                                    if (loadingOverlay) {
                                        loadingOverlay.classList.remove('active');
                                    }
                                    
                                    // Show error message
                                    alert('Error generating Detailed Report. Please try again.');
                                }
                            };
                            
                            // Handle Web Worker errors
                            pdfWorker.onerror = function(error) {
                                console.error('Web Worker error:', error);
                                
                                // Hide loading status and overlay
                                downloadPdfBtn.disabled = false;
                                pdfStatus.classList.add('hidden');
                                if (loadingOverlay) {
                                    loadingOverlay.classList.remove('active');
                                }
                                
                                // Show error message
                                alert('Error generating Detailed Report. Please try again.');
                            };
                        } catch (workerError) {
                            console.error('Failed to create Web Worker:', workerError);
                            
                            // Hide loading status and overlay
                            downloadPdfBtn.disabled = false;
                            pdfStatus.classList.add('hidden');
                            if (loadingOverlay) {
                                loadingOverlay.classList.remove('active');
                            }
                            
                            // Show error message
                            alert('PDF generation is not available in this browser. Please try a different browser.');
                            return;
                        }
                    }

                    // Update loading progress
                    if (loadingMessage) {
                        loadingMessage.textContent = 'Processing PDF generation...';
                    }
                    if (progressBar) {
                        progressBar.style.width = '70%';
                    }
                    if (step2) {
                        step2.classList.remove('active');
                        step2.classList.add('completed');
                    }
                    if (step3) {
                        step3.classList.add('active');
                    }

                    // Send data to Web Worker
                    pdfWorker.postMessage({ type: 'generatePDF', data: pdfData });

                    // Update final progress
                    if (loadingMessage) {
                        loadingMessage.textContent = 'Finalizing PDF...';
                    }
                    if (progressBar) {
                        progressBar.style.width = '90%';
                    }
                    if (step3) {
                        step3.classList.remove('active');
                        step3.classList.add('completed');
                    }
                    if (step4) {
                        step4.classList.add('active');
                    }

                } catch (error) {
                    console.error('Error preparing PDF data:', error);
                    
                    // Hide loading status and overlay
                    downloadPdfBtn.disabled = false;
                    pdfStatus.classList.add('hidden');
                    if (loadingOverlay) {
                        loadingOverlay.classList.remove('active');
                    }
                    
                    // Show error message
                    alert('Error preparing PDF data. Please try again.');
                }
            }
            
            // Modal functionality moved to inline-scripts.js for better performance
        });
    </script>
    <script src="inline-scripts.js" defer></script>
    <!-- Lightweight Instructions Modal -->
    <div id="instructions-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <div class="modal-title-icon"></div>
                    How to Use the Calculator
                </h3>
                <button id="close-modal-btn" class="modal-close-btn"></button>
            </div>
            
            <div class="modal-body">
                <p>Welcome! This tool helps you calculate Rotaract Club invoices quickly and accurately.</p>
                
                <h4>
                    <span class="step-number">1</span>
                    Add Members
                </h4>
                <ul>
                    <li><strong>Individual:</strong> Fill the form with member name, club base, and join date</li>
                    <li><strong>Bulk Upload:</strong> Upload Excel or CSV files with your member roster</li>
                    <li><strong>Templates:</strong> Use our CSV template or Google Sheets template for the correct format</li>
                </ul>

                <h4>
                    <span class="step-number">2</span>
                    Manage Roster
                </h4>
                <ul>
                    <li><strong>View:</strong> See all members in the organized table</li>
                    <li><strong>Edit:</strong> Click edit to modify member information</li>
                    <li><strong>Remove:</strong> Delete members as needed</li>
                </ul>

                <h4>
                    <span class="step-number">3</span>
                    Configure Settings
                </h4>
                <ul>
                    <li><strong>Invoice Year:</strong> Select the calculation year</li>
                    <li><strong>Tax Rate:</strong> Adjust tax percentage as applicable</li>
                    <li><strong>Auto-update:</strong> Calculations update in real-time</li>
                </ul>

                <h4>
                    <span class="step-number">4</span>
                    Generate Report
                </h4>
                <ul>
                    <li><strong>PDF Download:</strong> Get a detailed report with all calculations</li>
                    <li><strong>Summary:</strong> Includes dues breakdown and tax calculations</li>
                    <li><strong>Member Roster:</strong> Includes all members with their dues breakdown</li>
                </ul>

                <div class="modal-tips">
                    <h4> Quick Tips</h4>
                    <ul>
                        <li><strong>Google Sheets Template:</strong> Best for easy editing and collaboration - automatically creates a copy in your Google Drive</li>
                        <li><strong>CSV Template:</strong> Best for quick downloads and offline editing</li>
                        <li>Verify join dates for accurate calculations</li>
                        <li>Download the PDF to save your estimates</li>
                    </ul>
                </div>
            </div>
            
            <div class="modal-footer">
                <button id="got-it-btn" class="modal-btn">
                     Got it! Let's Start Calculating
                </button>
            </div>
        </div>
    </div>
</body>
</html>