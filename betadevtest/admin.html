<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), interest-cohort=()">
    <!-- Basic CSP for static hosting. Prefer setting headers server-side for stronger protection. -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: https://ui-avatars.com https://*.googleusercontent.com https://*.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://www.gstatic.com https://www.googleapis.com https://apis.google.com; connect-src 'self' https://*.googleapis.com https://*.gstatic.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com; frame-src 'self' https://clubinvoicecalculator.firebaseapp.com/ https://accounts.google.com; frame-ancestors 'none'; base-uri 'self'; form-action 'self'">
    <title>Admin Dashboard | Rotaract Club Invoice Calculator</title>
    
    <!-- Optimized Resource Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Optimized Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .sticky-header {
            position: sticky;
            top: 1rem;
            z-index: 40;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            transition: box-shadow 0.2s ease;
        }
        .sticky-header:hover {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
        }
        .sticky-tabs {
            position: sticky;
            top: 120px;
            z-index: 30;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid #e2e8f0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        .stat-card-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 4px 12px rgba(240, 147, 251, 0.2);
        }
        .stat-card-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.2);
        }
        .tab-button {
            padding: 0.875rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.15s ease;
            border: 1px solid transparent;
            font-size: 0.875rem;
        }
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
        }
        .tab-button:not(.active) {
            background: white;
            color: #6b7280;
            border-color: #e5e7eb;
        }
        .tab-button:not(.active):hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .table-container {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .table-header {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        .table-row:hover {
            background-color: #f8fafc;
        }
        .table-cell {
            padding: 1.25rem 1.5rem;
            vertical-align: middle;
        }
        .table-header-cell {
            padding: 1.5rem 1.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #374151;
        }
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }
        .pagination-info {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .filter-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        .activity-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 500;
            margin: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .activity-pill.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .activity-pill:not(.selected) {
            background: #f3f4f6;
            color: #6b7280;
            border-color: #e5e7eb;
        }
        .activity-pill:not(.selected):hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }
        
        /* Optimized Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
        }
        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
        }
        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
        }
        .btn-danger:hover:not(:disabled) {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.35);
        }
        .btn-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Optimized Loading States */
        .skeleton {
            background: #f3f4f6;
            border-radius: 0.25rem;
        }
        
        .skeleton-text {
            height: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        
        .skeleton-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
        }
        
        .skeleton-button {
            height: 2.5rem;
            border-radius: 0.5rem;
            width: 6rem;
        }
        
        /* Simple Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Optimized Table Design */
        .enhanced-table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .enhanced-table thead {
            background: #f8fafc;
        }
        
        .enhanced-table th {
            padding: 0.875rem 1.25rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .enhanced-table td {
            padding: 0.875rem 1.25rem;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .enhanced-table tbody tr:hover {
            background: #f8fafc;
        }
        
        .enhanced-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Status Indicators */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .status-inactive {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }
        
        .status-pending {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        /* Enhanced Mobile Responsiveness */
        @media (max-width: 768px) {
            .mobile-optimized {
                padding: 1rem;
            }
            
            .mobile-stack {
                flex-direction: column;
                gap: 1rem;
            }
            
            .mobile-full-width {
                width: 100%;
                min-width: 100%;
            }
            
            .mobile-text-center {
                text-align: center;
            }
            
            .mobile-hidden {
                display: none;
            }
            
            .mobile-table-scroll {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-table-min-width {
                min-width: 600px;
            }
            
            .mobile-card {
                border-radius: 1rem;
                margin: 0.5rem;
                padding: 1rem;
            }
            
            .mobile-button-large {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
                min-height: 3rem;
            }
            
            .mobile-gap {
                gap: 0.75rem;
            }
        }
        
        /* Touch-friendly interactions */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        .touch-friendly {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .touch-friendly:active {
            transform: scale(0.95);
        }
        
        /* Improved focus states for accessibility */
        .focus-visible:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Better text selection */
        ::selection {
            background: rgba(102, 126, 234, 0.2);
            color: #1f2937;
        }

        /* Simple Fast Confirmation System */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.1);
            z-index: 9999;
            display: none;
        }
        
        .confirm-overlay.show {
            display: block;
        }
        
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            max-width: 400px;
            width: calc(100vw - 2rem);
            z-index: 10000;
            opacity: 0;
            transition: all 0.2s ease;
        }
        
        .confirm-overlay.show .confirm-dialog {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .confirm-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
            line-height: 1.3;
        }
        
        .confirm-message {
            color: #6b7280;
            line-height: 1.5;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }
        
        .confirm-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        
        .confirm-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.15s ease;
            min-width: 80px;
        }
        
        .confirm-btn-cancel {
            background: #f9fafb;
            color: #6b7280;
            border-color: #d1d5db;
        }
        
        .confirm-btn-cancel:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .confirm-btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .confirm-btn-danger:hover {
            background: #dc2626;
        }
        
        .confirm-btn-success {
            background: #10b981;
            color: white;
        }
        
        .confirm-btn-success:hover {
            background: #059669;
        }
        
        .confirm-btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .confirm-btn-primary:hover {
            background: #2563eb;
        }
        
        /* Mobile responsive */
        @media (max-width: 640px) {
            .confirm-dialog {
                padding: 1.25rem;
                margin: 1rem;
            }
            
            .confirm-actions {
                flex-direction: column;
            }
            
            .confirm-btn {
                width: 100%;
                padding: 0.75rem 1rem;
            }
        }
    </style>
</head>
<body class="antialiased">
    <a href="#dashboard-content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-50 bg-white border border-gray-300 rounded px-3 py-1 shadow">Skip to content</a>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, orderBy, limit, getDocs, where, doc, getDoc, deleteDoc, updateDoc, setDoc, addDoc, getCountFromServer } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { firebaseConfig } from './firebase-config.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseProvider = provider;
        window.firebaseSignIn = signInWithPopup;
        window.firebaseSignOut = signOut;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        window.firebaseCollection = collection;
        window.firebaseQuery = query;
        window.firebaseOrderBy = orderBy;
        window.firebaseLimit = limit;
        window.firebaseGetDocs = getDocs;
        window.firebaseGetCountFromServer = getCountFromServer;
        window.firebaseWhere = where;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseSetDoc = setDoc;
        window.firebaseAddDoc = addDoc;
    </script>

    <div class="container mx-auto p-6 sm:p-8 lg:p-10">
        <!-- Header -->
        <div class="sticky-header bg-white rounded-2xl shadow-xl border border-gray-100 mx-4 mb-6">
            <div class="flex items-center justify-between py-6 px-6">
                <div class="flex items-center space-x-3">
                    <img src="rsamdio.png" alt="RSAMDIO Logo" class="h-8 w-auto" width="120" height="32" decoding="async" fetchpriority="high">
                    <div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">Admin Dashboard</h1>
                        <p class="text-xs text-gray-500">Rotaract Club Invoice Calculator</p>
                    </div>
                </div>
                
                <!-- Auth Section - Similar to main page -->
                <div class="flex items-center space-x-3">
                    <!-- Login State (Default) - Compact -->
                    <div id="auth-section" class="flex items-center">
                        <button id="login-btn" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-3 py-1.5 rounded-full shadow-lg border border-blue-400 cursor-pointer transition-all duration-200 flex items-center space-x-2 text-sm font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <span>Sign In</span>
                        </button>
                    </div>
                    
                    <!-- User State (Hidden by default) - Circular Profile with Dropdown -->
                    <div id="admin-user-info" class="hidden relative">
                        <!-- Profile Circle -->
                        <div id="profile-trigger" class="w-10 h-10 rounded-full shadow-lg border-2 border-white cursor-pointer transition-all duration-200 hover:shadow-xl hover:scale-105 flex items-center justify-center overflow-hidden">
                            <img id="user-avatar" class="w-[90%] h-[90%] rounded-full object-cover" src="" alt="User avatar" width="36" height="36" loading="lazy" decoding="async" referrerpolicy="no-referrer">
                        </div>
                        
                        <!-- Dropdown Menu -->
                        <div id="profile-dropdown" class="hidden absolute right-0 top-12 w-64 bg-white rounded-xl shadow-2xl border border-gray-200 py-2 z-50 transform transition-all duration-200 opacity-0 scale-95">
                            <!-- User Info Section -->
                            <div class="px-4 py-3 border-b border-gray-100">
                                <div class="flex items-center space-x-3">
                                    <img id="dropdown-avatar" class="w-10 h-10 rounded-full border-2 border-gray-200" src="" alt="User avatar" width="40" height="40" loading="lazy" decoding="async" referrerpolicy="no-referrer">
                                    <div class="flex-1 min-w-0">
                                        <p id="dropdown-name" class="text-sm font-semibold text-gray-900 truncate"></p>
                                        <p id="dropdown-email" class="text-xs text-gray-500 truncate"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Menu Items -->
                            <div class="py-1">
                                <button id="logout-btn" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 transition-colors duration-200 flex items-center space-x-3 group">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 group-hover:text-red-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                    </svg>
                                    <span class="group-hover:text-red-600 transition-colors">Sign out</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading State (Hidden by default) -->
                    <div id="loading-state" class="hidden bg-white text-gray-700 px-3 py-1.5 rounded-full shadow-lg border border-gray-200 flex items-center space-x-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-gray-300 border-t-blue-600"></div>
                        <span class="text-sm font-medium">Signing in...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Access Check -->
        <div id="admin-access-check" class="hidden bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-xl p-6 mb-6">
            <div class="flex items-center justify-center">
                <div class="animate-spin rounded-full h-6 w-6 border-2 border-yellow-400 border-t-yellow-600 mr-3"></div>
                <span class="text-yellow-800 font-medium">Checking admin access...</span>
            </div>
        </div>

        <!-- Access Denied -->
        <div id="access-denied" class="hidden bg-gradient-to-r from-red-50 to-pink-50 border border-red-200 rounded-xl p-8 mb-6 text-center">
            <div class="w-20 h-20 bg-gradient-to-r from-red-400 to-pink-400 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-red-800 mb-3">Access Denied</h2>
            <p class="text-red-600 mb-6 text-lg">You don't have admin privileges to access this dashboard.</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="go-home-btn" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 rounded-full text-white font-semibold shadow-lg border border-transparent bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:-translate-y-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span>Go to Home Page</span>
                </button>

            </div>
        </div>

        <!-- Main Dashboard Content -->
        <div id="dashboard-content" class="hidden">
            <!-- Dashboard Header -->
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 mb-8 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
                        <p class="text-gray-600 mt-1">Manage users and administrators</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <div class="text-sm text-gray-500">Total Admins</div>
                            <div id="total-admins" class="text-2xl font-bold text-green-600">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 mb-8">
                <div class="p-6">
                    <nav class="flex space-x-8" aria-label="Tabs">
                        <button id="users-tab" class="tab-button active flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <span class="text-lg font-semibold">User Management</span>
                        </button>
                        <button id="admins-tab" class="tab-button flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                            <span class="text-lg font-semibold">Administrators</span>
                        </button>
                    </nav>
                </div>
            </div>

            <!-- User Management Tab -->
            <div id="users-content" class="tab-content">
                <!-- User Search Section -->
                <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-8 mb-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Search User by Email</h3>
                            <p class="text-gray-600 text-sm">Enter the email address of the user you want to manage</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                            <div class="relative flex-1 sm:max-w-none lg:min-w-[500px] xl:min-w-[600px]">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <input 
                                    type="email" 
                                    id="user-email-search" 
                                    placeholder="Enter user email address..." 
                                    class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-white hover:bg-gray-50"
                                >
                                <div id="search-loading" class="hidden absolute inset-y-0 right-0 pr-3 flex items-center">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                            <button 
                                id="search-user-btn" 
                                class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 whitespace-nowrap"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                Search User
                            </button>
                        </div>
                    </div>
                    <div id="search-tips" class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-start">
                            <svg class="h-5 w-5 text-blue-500 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="text-sm text-blue-700">
                                <p class="font-medium mb-1">Search Tips:</p>
                                <ul class="space-y-1 text-blue-600">
                                    <li>• Enter the exact email address used during registration</li>
                                    <li>• Check for typos and extra spaces</li>
                                    <li>• Use lowercase letters for better matching</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Data Display -->
                <div id="user-data-display" class="hidden">
                    <!-- User Profile Card -->
                    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 mb-8 p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-800">User Profile</h3>
                            <div class="flex space-x-3">
                                <button id="promote-user-btn" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12" />
                                    </svg>
                                    Promote to Admin
                                </button>
                                <button id="demote-user-btn" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105 hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6" />
                                    </svg>
                                    Demote from Admin
                                </button>
                                <button id="delete-user-btn" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    Delete User
                                </button>
                            </div>
                        </div>
                        
                        <div id="user-profile-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- User info will be populated here -->
                        </div>
                    </div>

                    <!-- User Settings -->
                    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 mb-8 p-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">User Settings</h3>
                        <div id="user-settings-content" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Settings will be populated here -->
                        </div>
                    </div>

                    <!-- Member Roster -->
                    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 mb-8 p-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Member Roster</h3>
                        <div id="member-roster-content">
                            <!-- Member roster will be populated here -->
                        </div>
                    </div>

                    <!-- Invoice Summaries -->
                    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 mb-8 p-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Invoice Summaries</h3>
                        <div id="invoice-summaries-content">
                            <!-- Invoice summaries will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- No User Found State -->
                <div id="no-user-found" class="hidden">
                    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-12 text-center">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-red-100 to-red-200 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-3">No User Found</h3>
                        <p class="text-gray-600 mb-6 max-w-md mx-auto">We couldn't find a user with the email address you entered. Please check the spelling and try again.</p>
                        <div class="flex flex-col sm:flex-row gap-3 justify-center">
                            <button onclick="document.getElementById('user-email-search').focus()" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium rounded-lg transition-all duration-200 transform hover:scale-105">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                Try Another Search
                            </button>
                            <button onclick="clearSearch()" class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Clear Search
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Initial State -->
                <div id="initial-user-state">
                    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-12 text-center">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-blue-100 to-blue-200 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-3">Search for a User</h3>
                        <p class="text-gray-600 mb-6 max-w-md mx-auto">Enter a user's email address above to view their data, manage their account, and access their invoice summaries.</p>
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 max-w-lg mx-auto">
                            <h4 class="font-semibold text-gray-800 mb-3">What you can do:</h4>
                            <ul class="text-sm text-gray-600 space-y-2 text-left">
                                <li class="flex items-center">
                                    <svg class="h-4 w-4 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    View user profile and settings
                                </li>
                                <li class="flex items-center">
                                    <svg class="h-4 w-4 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    Manage member roster
                                </li>
                                <li class="flex items-center">
                                    <svg class="h-4 w-4 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    Access invoice summaries
                                </li>
                                <li class="flex items-center">
                                    <svg class="h-4 w-4 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    Promote or demote users
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Administrators Tab -->
            <div id="admins-content" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Administrators</h2>
                        <button id="refresh-admins-btn" class="btn-secondary px-4 py-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Refresh
                        </button>
                    </div>
                    
                    <div id="admins-table-container">
                        <!-- Admins table will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Fast Confirmation Dialog -->
    <div id="confirm-overlay" class="confirm-overlay">
        <div class="confirm-dialog">
            <h3 id="confirm-title" class="confirm-title">Confirm Action</h3>
            <p id="confirm-message" class="confirm-message">Are you sure you want to proceed with this action?</p>
            <div class="confirm-actions">
                <button id="confirm-cancel" class="confirm-btn confirm-btn-cancel">Cancel</button>
                <button id="confirm-action" class="confirm-btn confirm-btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let isAdmin = false;
        let currentTab = 'users';
        let currentSearchedUser = null; // Store the currently searched user data
        let currentUserInvoices = []; // Store the current user's invoice summaries
        
        // Pagination variables
        let usersPage = 1;
        let usersPerPage = 20;
        let adminsPage = 1;
        let adminsPerPage = 20;
        let summariesPage = 1;
        let summariesPerPage = 20;
        let memberRosterPage = 1;
        let memberRosterPerPage = 10;
        let invoiceSummariesPage = 1;
        let invoiceSummariesPerPage = 10;
        // Remember last viewed user for the User Data tab
        let lastViewedUserId = null;

        // Global cache for Firestore data to reduce reads
        const firestoreCache = {
            users: {
                data: null,
                lastFetched: null,
                cacheDuration: 5 * 60 * 1000, // 5 minutes
                admins: {
                    data: null,
                    lastFetched: null,
                    cacheDuration: 10 * 60 * 1000 // 10 minutes
                }
            },
            summaries: {
                data: null,
                lastFetched: null,
                cacheDuration: 2 * 60 * 1000 // 2 minutes
            },
            stats: {
                data: null,
                lastFetched: null,
                cacheDuration: 5 * 60 * 1000 // 5 minutes
            }
        };

        // Cache management functions
        function isCacheValid(cacheKey, subKey = null) {
            const cache = subKey ? firestoreCache[cacheKey][subKey] : firestoreCache[cacheKey];
            if (!cache.data || !cache.lastFetched) return false;
            return (Date.now() - cache.lastFetched) < cache.cacheDuration;
        }

        function updateCache(cacheKey, data, subKey = null) {
            const cache = subKey ? firestoreCache[cacheKey][subKey] : firestoreCache[cacheKey];
            cache.data = data;
            cache.lastFetched = Date.now();
            // Update cache status display
            updateCacheStatusDisplay();
        }

        function clearCache(cacheKey, subKey = null) {
            if (subKey) {
                firestoreCache[cacheKey][subKey].data = null;
                firestoreCache[cacheKey][subKey].lastFetched = null;
            } else {
                firestoreCache[cacheKey].data = null;
                firestoreCache[cacheKey].lastFetched = null;
            }
        }

        // Optimized Firebase authentication initialization
        function initializeAuth() {
            window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
                if (user) {
                    currentUser = user;
                    updateAuthUI(user);
                    checkAdminAccess(user.uid);
                } else {
                    currentUser = null;
                    isAdmin = false;
                    updateAuthUI(null);
                    hideDashboard();
                }
            });

            // Cache DOM elements for better performance
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const goHomeBtn = document.getElementById('go-home-btn');
            const profileTrigger = document.getElementById('profile-trigger');
            const profileDropdown = document.getElementById('profile-dropdown');
            
            // Add event listeners with cached elements
            if (loginBtn) loginBtn.addEventListener('click', handleLogin);
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            if (goHomeBtn) goHomeBtn.addEventListener('click', goToHome);
            
            // Optimized profile dropdown functionality
            if (profileTrigger && profileDropdown) {
                profileTrigger.addEventListener('click', () => {
                    profileDropdown.classList.toggle('hidden');
                });
                
                // Single event listener for outside clicks
                document.addEventListener('click', (e) => {
                    if (!profileTrigger.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                });
            }
        }

        function updateAuthUI(user) {
            const authSection = document.getElementById('auth-section');
            const userInfo = document.getElementById('admin-user-info');
            const loadingState = document.getElementById('loading-state');
            const userAvatar = document.getElementById('user-avatar');
            const dropdownAvatar = document.getElementById('dropdown-avatar');
            const dropdownName = document.getElementById('dropdown-name');
            const dropdownEmail = document.getElementById('dropdown-email');

            if (user) {
                authSection.classList.add('hidden');
                loadingState.classList.add('hidden');
                userInfo.classList.remove('hidden');
                
                // Set user avatar
                const avatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}&background=3b82f6&color=fff&size=128`;
                userAvatar.src = avatarUrl;
                dropdownAvatar.src = avatarUrl;
                
                // Set user info
                dropdownName.textContent = user.displayName || 'User';
                dropdownEmail.textContent = user.email;
            } else {
                authSection.classList.remove('hidden');
                userInfo.classList.add('hidden');
                loadingState.classList.add('hidden');
                
                // Clear user info
                userAvatar.src = '';
                dropdownAvatar.src = '';
                dropdownName.textContent = '';
                dropdownEmail.textContent = '';
            }
        }

        async function handleLogin() {
            const authSection = document.getElementById('auth-section');
            const loadingState = document.getElementById('loading-state');
            
            try {
                authSection.classList.add('hidden');
                loadingState.classList.remove('hidden');
                
                try {
                    await window.firebaseSignIn(window.firebaseAuth, window.firebaseProvider);
                } catch (popupError) {
                    // If popup blocked or disallowed by browser/CSP, fallback to redirect
                    if (popupError && (popupError.code === 'auth/popup-blocked' || popupError.code === 'auth/popup-closed-by-user' || popupError.code === 'auth/unauthorized-domain')) {
                        const { signInWithRedirect } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                        await signInWithRedirect(window.firebaseAuth, window.firebaseProvider);
                        return; // redirect in progress
                    }
                    throw popupError;
                }
            } catch (error) {
                const friendly = (msg) => showNotification(msg, 'error');
                if (error && error.code === 'auth/unauthorized-domain') {
                    friendly('Login failed: unauthorized domain. Add this domain to Firebase Auth > Authorized Domains.');
                } else if (error && error.code === 'auth/popup-blocked') {
                    friendly('Popup was blocked. Please enable popups for this site, or try again.');
                } else {
                    friendly('Login failed. Please try again.');
                }
                
                // Reset UI on error
                authSection.classList.remove('hidden');
                loadingState.classList.add('hidden');
            }
        }

        async function handleLogout() {
            try {
                await window.firebaseSignOut(window.firebaseAuth);
            } catch (error) {
                // Silent logout error handling
            }
        }

        async function checkAdminAccess(userId) {
            document.getElementById('admin-access-check').classList.remove('hidden');
            
            try {
                // Check if user is admin
                const adminDoc = await window.firebaseGetDoc(window.firebaseDoc(window.firebaseDB, 'admins', userId));
                
                if (adminDoc.exists()) {
                    isAdmin = true;
                    showDashboard();
                    loadDashboardData();
                } else {
                    isAdmin = false;
                    showAccessDenied();
                }
            } catch (error) {
                showAccessDenied();
            } finally {
                document.getElementById('admin-access-check').classList.add('hidden');
            }
        }

        function showDashboard() {
            document.getElementById('dashboard-content').classList.remove('hidden');
            document.getElementById('access-denied').classList.add('hidden');
        }

        function hideDashboard() {
            document.getElementById('dashboard-content').classList.add('hidden');
            document.getElementById('access-denied').classList.add('hidden');
        }

        function showAccessDenied() {
            document.getElementById('access-denied').classList.remove('hidden');
        }

        function goToHome() {
            window.location.href = 'index.html';
        }

        async function loadDashboardData() {
            // Load basic stats
            updateBaseStats();
        }

        // Search user by email
        async function searchUserByEmail(email, showLoading = true) {
            if (!email || email.trim() === '') {
                showNotification('Please enter a valid email address', 'error');
                return;
            }

            const searchInput = document.getElementById('user-email-search');
            const searchBtn = document.getElementById('search-user-btn');
            const searchLoading = document.getElementById('search-loading');
            const searchTips = document.getElementById('search-tips');

            if (showLoading) {
                // Show loading state
                searchBtn.disabled = true;
                searchBtn.innerHTML = `
                    <div class="loading-spinner mr-2"></div>
                    Searching...
                `;
                searchLoading.classList.remove('hidden');
                searchTips.classList.add('hidden');
            }

            try {
                // Query users collection by email
                const usersQuery = window.firebaseQuery(
                    window.firebaseCollection(window.firebaseDB, 'users'),
                    window.firebaseWhere('email', '==', email.trim().toLowerCase())
                );
                const querySnapshot = await window.firebaseGetDocs(usersQuery);

                if (querySnapshot.empty) {
                    showNoUserFound();
                    showNotification('No user found with this email address', 'error');
                } else {
                    const userDoc = querySnapshot.docs[0];
                    const userData = {
                        id: userDoc.id,
                        ...userDoc.data()
                    };

                    // Check if user is admin
                    try {
                        const adminDoc = await window.firebaseGetDoc(window.firebaseDoc(window.firebaseDB, 'admins', userData.id));
                        userData.isAdmin = adminDoc.exists();
                    } catch (error) {
                        userData.isAdmin = false;
                    }

                    // Store current user data
                    currentSearchedUser = userData;

                    // Load user's invoice summaries
                    await loadUserInvoices(userData.email);

                    // Display user data
                    displayUserData(userData);

                    showNotification(`Found user: ${userData.displayName || userData.email}`, 'success');
                }
            } catch (error) {
                showNotification('Error searching for user: ' + error.message, 'error');
                showNoUserFound();
            } finally {
                if (showLoading) {
                    // Reset loading state
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Search User
                    `;
                    searchLoading.classList.add('hidden');
                    searchTips.classList.remove('hidden');
                }
            }
        }

        // Load user's invoice summaries
        async function loadUserInvoices(email) {
            try {
                const summariesQuery = window.firebaseQuery(
                    window.firebaseCollection(window.firebaseDB, 'invoice_summaries'),
                    window.firebaseWhere('email', '==', email)
                );
                const querySnapshot = await window.firebaseGetDocs(summariesQuery);
                currentUserInvoices = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    currentUserInvoices.push({
                        id: doc.id,
                        ...data
                    });
                });
                currentUserInvoices.sort((a, b) => {
                    const timestampA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                    const timestampB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                    return timestampB - timestampA; // Descending order (newest first)
                });
            } catch (error) {
                showNotification('Error loading invoice summaries: ' + error.message, 'error');
                currentUserInvoices = [];
            }
        }

        // (removed legacy duplicate searchUserByEmail)

        // Display user data
        function displayUserData(userData) {
            // Hide initial state and no user found
            document.getElementById('initial-user-state').classList.add('hidden');
            document.getElementById('no-user-found').classList.add('hidden');
            
            // Show user data display
            document.getElementById('user-data-display').classList.remove('hidden');
            
            // Reset pagination for new user data
            memberRosterPage = 1;
            invoiceSummariesPage = 1;
            
            // Update action buttons based on admin status
            const promoteBtn = document.getElementById('promote-user-btn');
            const demoteBtn = document.getElementById('demote-user-btn');
            
            if (userData.isAdmin) {
                promoteBtn.classList.add('hidden');
                demoteBtn.classList.remove('hidden');
            } else {
                promoteBtn.classList.remove('hidden');
                demoteBtn.classList.add('hidden');
            }
            
            // Display user profile
            displayUserProfile(userData);
            
            // Display user settings
            displayUserSettings(userData);
            
            // Display member roster
            displayMemberRoster(userData);
            
            // Display invoice summaries
            displayInvoiceSummaries();
        }

        // Display user profile
        function displayUserProfile(userData) {
            const profileContent = document.getElementById('user-profile-content');
            
            profileContent.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                        <p class="text-lg text-gray-900">${userData.displayName || 'Not set'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <p class="text-lg text-gray-900">${userData.email || 'Not set'}</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">User ID</label>
                        <p class="text-sm text-gray-600 font-mono">${userData.id}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${userData.isAdmin ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${userData.isAdmin ? 'Admin' : 'User'}
                        </span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Login</label>
                        <p class="text-sm text-gray-600">${formatDate(userData.lastLogin)}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Created</label>
                        <p class="text-sm text-gray-600">${formatDate(userData.createdAt)}</p>
                    </div>
                </div>
            `;
        }

        // Display user settings
        function displayUserSettings(userData) {
            const settingsContent = document.getElementById('user-settings-content');
            
            if (userData.settings) {
                settingsContent.innerHTML = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tax Percentage</label>
                        <p class="text-lg text-gray-900">${userData.settings.taxPercentage || 'Not set'}%</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Currency Rate</label>
                        <p class="text-lg text-gray-900">${userData.settings.currencyRate || 'Not set'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Year</label>
                        <p class="text-lg text-gray-900">${userData.settings.invoiceYear || 'Not set'}</p>
                    </div>
                `;
            } else {
                settingsContent.innerHTML = `
                    <div class="col-span-3">
                        <p class="text-gray-500 text-center py-4">No settings data available.</p>
                    </div>
                `;
            }
        }

        // Display member roster
        function displayMemberRoster(userData) {
            const rosterContent = document.getElementById('member-roster-content');
            
            if (userData.memberRoster && userData.memberRoster.length > 0) {
                // Calculate pagination
                const totalMembers = userData.memberRoster.length;
                const totalPages = Math.ceil(totalMembers / memberRosterPerPage);
                const startIndex = (memberRosterPage - 1) * memberRosterPerPage;
                const endIndex = Math.min(startIndex + memberRosterPerPage, totalMembers);
                const currentPageMembers = userData.memberRoster.slice(startIndex, endIndex);
                
                rosterContent.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Join Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Leave Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Member Type</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${currentPageMembers.map(member => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${member.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.joinDate}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.leaveDate || 'Active'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.memberType}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${totalPages > 1 ? `
                        <div class="mt-4 flex items-center justify-between">
                            <div class="text-sm text-gray-700">
                                Showing ${startIndex + 1} to ${endIndex} of ${totalMembers} members
                            </div>
                            <div class="flex items-center space-x-2">
                                <button 
                                    onclick="changeMemberRosterPage(${memberRosterPage - 1})" 
                                    class="px-3 py-1 text-sm border border-gray-300 rounded-md ${memberRosterPage <= 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50'}"
                                    ${memberRosterPage <= 1 ? 'disabled' : ''}
                                >
                                    Previous
                                </button>
                                <span class="text-sm text-gray-700">
                                    Page ${memberRosterPage} of ${totalPages}
                                </span>
                                <button 
                                    onclick="changeMemberRosterPage(${memberRosterPage + 1})" 
                                    class="px-3 py-1 text-sm border border-gray-300 rounded-md ${memberRosterPage >= totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50'}"
                                    ${memberRosterPage >= totalPages ? 'disabled' : ''}
                                >
                                    Next
                                </button>
                            </div>
                        </div>
                    ` : ''}
                `;
            } else {
                rosterContent.innerHTML = `
                    <p class="text-gray-500 text-center py-4">No member roster data available.</p>
                `;
            }
        }

        // Display invoice summaries
        function displayInvoiceSummaries() {
            const summariesContent = document.getElementById('invoice-summaries-content');
            
            if (currentUserInvoices.length > 0) {
                // Calculate pagination
                const totalInvoices = currentUserInvoices.length;
                const totalPages = Math.ceil(totalInvoices / invoiceSummariesPerPage);
                const startIndex = (invoiceSummariesPage - 1) * invoiceSummariesPerPage;
                const endIndex = Math.min(startIndex + invoiceSummariesPerPage, totalInvoices);
                const currentPageInvoices = currentUserInvoices.slice(startIndex, endIndex);
                
                summariesContent.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice Year</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Members</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tax %</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Currency Rate</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prorated Months</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Base Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tax Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total (USD)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Local Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${currentPageInvoices.map(summary => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${summary.invoiceYear || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${summary.totalMembers || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${summary.taxPercentage || summary.settings?.taxPercentage || 'N/A'}%</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${summary.currencyRate || summary.settings?.currencyRate || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${summary.totalProratedMonths || summary.proratedMonths || summary.settings?.totalProratedMonths || summary.settings?.proratedMonths || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${formatNumber(summary.totals?.baseAmount || 0)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${formatNumber(summary.totals?.taxAmount || 0)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${formatNumber(summary.totals?.totalWithTax || 0)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatLocalTotal(summary.totals?.totalWithTax || 0, summary.currencyRate || summary.settings?.currencyRate)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(summary.timestamp)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button data-invoice-id="${summary.id}" class="delete-invoice-btn inline-flex items-center px-2 py-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white text-xs font-medium rounded-md shadow-sm hover:shadow-md transition-all duration-200 transform hover:scale-105">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${totalPages > 1 ? `
                        <div class="mt-4 flex items-center justify-between">
                            <div class="text-sm text-gray-700">
                                Showing ${startIndex + 1} to ${endIndex} of ${totalInvoices} invoices
                            </div>
                            <div class="flex items-center space-x-2">
                                <button 
                                    onclick="changeInvoiceSummariesPage(${invoiceSummariesPage - 1})" 
                                    class="px-3 py-1 text-sm border border-gray-300 rounded-md ${invoiceSummariesPage <= 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50'}"
                                    ${invoiceSummariesPage <= 1 ? 'disabled' : ''}
                                >
                                    Previous
                                </button>
                                <span class="text-sm text-gray-700">
                                    Page ${invoiceSummariesPage} of ${totalPages}
                                </span>
                                <button 
                                    onclick="changeInvoiceSummariesPage(${invoiceSummariesPage + 1})" 
                                    class="px-3 py-1 text-sm border border-gray-300 rounded-md ${invoiceSummariesPage >= totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50'}"
                                    ${invoiceSummariesPage >= totalPages ? 'disabled' : ''}
                                >
                                    Next
                                </button>
                            </div>
                        </div>
                    ` : ''}
                `;

                // Add event listeners for delete buttons with better handling
                const deleteButtons = summariesContent.querySelectorAll('.delete-invoice-btn');
                deleteButtons.forEach(button => {
                    // Remove any existing listeners first
                    button.replaceWith(button.cloneNode(true));
                    const newButton = summariesContent.querySelector(`[data-invoice-id="${button.getAttribute('data-invoice-id')}"]`);
                    
                    newButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const invoiceId = this.getAttribute('data-invoice-id');
                        if (invoiceId) {
                            deleteInvoiceSummary(invoiceId, this);
                        }
                    });
                });
            } else {
                summariesContent.innerHTML = `
                    <p class="text-gray-500 text-center py-4">No invoice summaries found for this user.</p>
                `;
            }
        }

        // Show no user found state
        function showNoUserFound() {
            document.getElementById('initial-user-state').classList.add('hidden');
            document.getElementById('user-data-display').classList.add('hidden');
            document.getElementById('no-user-found').classList.remove('hidden');
        }

        // Promote user to admin
        async function promoteUser() {
            if (!currentSearchedUser) return;

            const confirmed = await showConfirm({
                title: 'Promote User to Admin',
                message: `Are you sure you want to promote ${currentSearchedUser.displayName || currentSearchedUser.email} to administrator? This will give them full access to the admin dashboard.`,
                confirmText: 'Promote User',
                cancelText: 'Cancel',
                confirmButtonClass: 'confirm-btn-success'
            });

            if (!confirmed) return;

            try {
                const adminDocRef = window.firebaseDoc(window.firebaseDB, 'admins', currentSearchedUser.id);
                await window.firebaseSetDoc(adminDocRef, {
                    userId: currentSearchedUser.id,
                    email: currentSearchedUser.email,
                    displayName: currentSearchedUser.displayName,
                    isAdmin: true,
                    updatedBy: currentUser.uid,
                    updatedAt: new Date().toISOString()
                }, { merge: true });

                currentSearchedUser.isAdmin = true;
                displayUserData(currentSearchedUser);
                showNotification('User promoted to admin successfully!', 'success');
            } catch (error) {
                showNotification('Failed to promote user.', 'error');
            }
        }

        // Demote user from admin
        async function demoteUser() {
            if (!currentSearchedUser) return;

            const confirmed = await showConfirm({
                title: 'Demote User from Admin',
                message: `Are you sure you want to demote ${currentSearchedUser.displayName || currentSearchedUser.email} from administrator? This will remove their admin privileges.`,
                confirmText: 'Demote User',
                cancelText: 'Cancel',
                confirmButtonClass: 'confirm-btn-danger'
            });

            if (!confirmed) return;

            try {
                const adminDocRef = window.firebaseDoc(window.firebaseDB, 'admins', currentSearchedUser.id);
                await window.firebaseDeleteDoc(adminDocRef);

                currentSearchedUser.isAdmin = false;
                displayUserData(currentSearchedUser);
                showNotification('User demoted from admin successfully!', 'success');
            } catch (error) {
                showNotification('Failed to demote user.', 'error');
            }
        }

        // Delete user
        async function deleteUser() {
            if (!currentSearchedUser) return;

            const confirmed = await showConfirm({
                title: 'Delete User Account',
                message: `Are you sure you want to permanently delete ${currentSearchedUser.displayName || currentSearchedUser.email}? This action will delete all user data, admin records, and invoice summaries. This action cannot be undone.`,
                confirmText: 'Delete User',
                cancelText: 'Cancel',
                confirmButtonClass: 'confirm-btn-danger'
            });

            if (!confirmed) return;

            try {
                const userEmail = currentSearchedUser.email;
                const userId = currentSearchedUser.id;
                
                // Show loading notification
                showNotification('Deleting user and all associated data...', 'info');
                
                // 1. Delete all invoice summaries for this user
                try {
                    showNotification('Deleting invoice summaries...', 'info');
                    const summariesQuery = window.firebaseQuery(
                        window.firebaseCollection(window.firebaseDB, 'invoice_summaries'),
                        window.firebaseWhere('email', '==', userEmail)
                    );
                    const summariesSnapshot = await window.firebaseGetDocs(summariesQuery);
                    
                    const deletePromises = summariesSnapshot.docs.map(doc => 
                        window.firebaseDeleteDoc(doc.ref)
                    );
                    
                    await Promise.all(deletePromises);
                    showNotification(`Deleted ${summariesSnapshot.size} invoice summaries`, 'success');
                } catch (error) {
                    showNotification('Warning: Some invoice summaries may not have been deleted', 'error');
                    // Continue with other deletions even if this fails
                }
                
                // 2. Delete admin record if exists
                try {
                    showNotification('Deleting admin record...', 'info');
                    await window.firebaseDeleteDoc(window.firebaseDoc(window.firebaseDB, 'admins', userId));
                    showNotification('Admin record deleted', 'success');
                } catch (error) {
                    showNotification('Warning: Admin record may not have been deleted', 'error');
                    // Admin record might not exist, continue
                }
                
                // 3. Delete user document
                try {
                    showNotification('Deleting user data...', 'info');
                    await window.firebaseDeleteDoc(window.firebaseDoc(window.firebaseDB, 'users', userId));
                    showNotification('User data deleted', 'success');
                } catch (error) {
                    throw error; // Re-throw as this is critical
                }

                showNotification(`User ${currentSearchedUser.displayName || currentSearchedUser.email} and all associated data deleted successfully!`, 'success');
                
                // Reset to initial state
                currentSearchedUser = null;
                currentUserInvoices = [];
                document.getElementById('user-email-search').value = '';
                document.getElementById('initial-user-state').classList.remove('hidden');
                document.getElementById('user-data-display').classList.add('hidden');
                document.getElementById('no-user-found').classList.add('hidden');
                
                // Refresh admin count in dashboard header
                updateBaseStats();
                
            } catch (error) {
                showNotification('Failed to delete user. Some data may have been deleted. Please check the console for details.', 'error');
            }
        }

        // Delete invoice summary
        async function deleteInvoiceSummary(invoiceId, buttonElement) {
            const confirmed = await showConfirm({
                title: 'Delete Invoice Summary',
                message: 'Are you sure you want to delete this invoice summary? This action cannot be undone.',
                confirmText: 'Delete',
                cancelText: 'Cancel',
                confirmButtonClass: 'confirm-btn-danger'
            });

            if (!confirmed) return;

            try {
                // Delete invoice summary document
                await window.firebaseDeleteDoc(window.firebaseDoc(window.firebaseDB, 'invoice_summaries', invoiceId));
                
                // Remove from local array
                currentUserInvoices = currentUserInvoices.filter(invoice => invoice.id !== invoiceId);
                
                showNotification('Invoice summary deleted successfully!', 'success');
                
                // Re-display the invoice summaries with updated data
                displayInvoiceSummaries();
            } catch (error) {
                showNotification('Failed to delete invoice summary.', 'error');
            }
        }

        // These functions are no longer needed with the new design

        // These functions are no longer needed with the new design

        // (Removed loadUsers function - we only load individual user data via search)

        // Load admins
        async function loadAdmins(showLoading = false, forceRefresh = false) {
            const refreshBtn = document.getElementById('refresh-admins-btn');
            let originalText = null;

            try {
                if (showLoading && refreshBtn) {
                    originalText = refreshBtn.innerHTML;
                    refreshBtn.innerHTML = `
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Loading...
                    `;
                    refreshBtn.disabled = true;
                }
                
                // Load admins from Firestore
                const adminsQuery = window.firebaseQuery(
                    window.firebaseCollection(window.firebaseDB, 'admins'),
                    window.firebaseOrderBy('updatedAt', 'desc')
                );
                
                const querySnapshot = await window.firebaseGetDocs(adminsQuery);
                const adminsData = [];

                querySnapshot.forEach((doc) => {
                    adminsData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                displayAdmins(adminsData);
            } catch (error) {
                showNotification('Failed to load admins.', 'error');
            } finally {
                if (showLoading && refreshBtn && originalText) {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }
            }
        }

        // Display admins
        function displayAdmins(adminsData) {
            const container = document.getElementById('admins-table-container');
            
            if (adminsData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No Administrators Found</h3>
                        <p class="text-gray-500">There are no administrators in the system.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admin</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Updated By</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Updated At</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${adminsData.map(admin => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-10 w-10">
                                                <img class="h-10 w-10 rounded-full" src="${admin.photoURL ? escapeAttribute(admin.photoURL) : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDEyQzE0LjIwOTEgMTIgMTYgMTAuMjA5MSAxNiA4QzE2IDUuNzkwODYgMTQuMjA5MSA0IDEyIDRDOS43OTA4NiA0IDggNS43OTA4NiA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTJaIiBmaWxsPSIjNkI3MjgwIi8+CjxwYXRoIGQ9Ik0xMiAxNEM5LjMzIDE0IDcgMTYuMzMgNyAxOVYyMEgxN1YxOUMxNyAxNi4zMyAxNC42NyAxNCAxMiAxNFoiIGZpbGw9IiM2QjcyODAiLz4KPC9zdmc+'}" alt="${escapeAttribute(admin.displayName || 'Admin')}" width="40" height="40" loading="lazy" decoding="async" referrerpolicy="no-referrer">
                                            </div>
                                            <div class="ml-4">
                                                <div class="text-sm font-medium text-gray-900">${escapeHTML(admin.displayName || 'Unknown')}</div>
                                                <div class="text-sm text-gray-500">${escapeHTML(admin.userId)}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${escapeHTML(admin.email || 'No email')}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHTML(admin.updatedBy || 'Unknown')}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(admin.updatedAt)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="demoteAdmin('${admin.id}', this)" class="inline-flex items-center px-3 py-1 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white text-xs font-medium rounded-md shadow-sm hover:shadow-md transition-all duration-200 transform hover:scale-105">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6" />
                                            </svg>
                                            Demote
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Demote admin
        async function demoteAdmin(adminId, buttonElement) {
            const confirmed = await showConfirm({
                title: 'Demote Administrator',
                message: 'Are you sure you want to demote this administrator? They will lose access to the admin dashboard.',
                confirmText: 'Demote',
                cancelText: 'Cancel',
                confirmButtonClass: 'confirm-btn-danger'
            });

            if (!confirmed) return;

            try {
                await window.firebaseDeleteDoc(window.firebaseDoc(window.firebaseDB, 'admins', adminId));
                showNotification('Administrator demoted successfully!', 'success');
                loadAdmins(); // Reload the list
            } catch (error) {
                showNotification('Failed to demote administrator.', 'error');
            }
        }

        // This function is no longer needed with the new design

        // This function is no longer needed with the new design

        // This function is no longer needed with the new design

        // This function is no longer needed with the new design

        // This function is no longer needed with the new design

        // This function is no longer needed with the new design

        // This function is no longer needed with the new design

        // This function is no longer needed with the new design

        // This function is no longer needed with the new design

        function formatNumber(num) {
            if (num === null || num === undefined) return '0.00';
            return parseFloat(num).toFixed(2);
        }

        // Format local currency total
        function formatLocalTotal(usdAmount, currencyRate) {
            if (!usdAmount || !currencyRate || currencyRate === 'N/A') {
                return 'N/A';
            }
            try {
                const rate = parseFloat(currencyRate);
                const localAmount = parseFloat(usdAmount) * rate;
                return localAmount.toFixed(2);
            } catch (error) {
                return 'N/A';
            }
        }

        // Pagination control functions
        function changeMemberRosterPage(newPage) {
            if (newPage >= 1 && newPage <= Math.ceil((currentSearchedUser?.memberRoster?.length || 0) / memberRosterPerPage)) {
                memberRosterPage = newPage;
                displayMemberRoster(currentSearchedUser);
            }
        }

        function changeInvoiceSummariesPage(newPage) {
            if (newPage >= 1 && newPage <= Math.ceil(currentUserInvoices.length / invoiceSummariesPerPage)) {
                invoiceSummariesPage = newPage;
                displayInvoiceSummaries();
            }
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show selected tab content
            const selectedContent = document.getElementById(`${tabName}-content`);
            selectedContent.classList.remove('hidden');

            // Add active class to selected tab button
            const activeButton = document.getElementById(`${tabName}-tab`);
            activeButton.classList.add('active');
            activeButton.setAttribute('aria-selected', 'true');
            document.querySelectorAll('[aria-controls]').forEach(btn => {
                if (btn.id !== `${tabName}-tab`) btn.setAttribute('aria-selected', 'false');
            });

            currentTab = tabName;

            // Load data for the selected tab
            if (tabName === 'users') {
                // Preserve user data if it exists, otherwise show initial state
                if (currentSearchedUser) {
                    // Re-display the user data that was previously loaded
                    document.getElementById('initial-user-state').classList.add('hidden');
                    document.getElementById('no-user-found').classList.add('hidden');
                    document.getElementById('user-data-display').classList.remove('hidden');
                    
                    // Preserve the search input value
                    const searchInput = document.getElementById('user-email-search');
                    if (searchInput && currentSearchedUser.email) {
                        searchInput.value = currentSearchedUser.email;
                    }
                    
                    displayUserData(currentSearchedUser);
                } else {
                    // Show initial state only if no user data exists
                    document.getElementById('initial-user-state').classList.remove('hidden');
                    document.getElementById('user-data-display').classList.add('hidden');
                    document.getElementById('no-user-found').classList.add('hidden');
                }
            } else if (tabName === 'admins') {
                loadAdmins();
            }
        }

        // These functions are no longer needed with the new design

        // Utility Functions
        function showNotification(message, type = 'info') {
            showEnhancedNotification(message, type, 4000);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // Basic escaping helpers used by table renderers
        function escapeHTML(value) {
            if (value == null) return '';
            return String(value)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function escapeAttribute(value) {
            return escapeHTML(value);
        }

        // No-op cache status updater to avoid errors from legacy calls
        function updateCacheStatusDisplay() {}

        // Optimized event listener setup
        function setupEventListeners() {
            // Cache all DOM elements for better performance
            const elements = {
                usersTab: document.getElementById('users-tab'),
                adminsTab: document.getElementById('admins-tab'),
                searchBtn: document.getElementById('search-user-btn'),
                emailInput: document.getElementById('user-email-search'),
                promoteBtn: document.getElementById('promote-user-btn'),
                demoteBtn: document.getElementById('demote-user-btn'),
                deleteBtn: document.getElementById('delete-user-btn'),
                refreshAdminsBtn: document.getElementById('refresh-admins-btn')
            };
            
            // Tab switching
            if (elements.usersTab) elements.usersTab.addEventListener('click', () => switchTab('users'));
            if (elements.adminsTab) elements.adminsTab.addEventListener('click', () => switchTab('admins'));

            // Search functionality
            if (elements.searchBtn && elements.emailInput) {
                elements.searchBtn.addEventListener('click', () => {
                    const email = elements.emailInput.value.trim();
                    if (email) searchUserByEmail(email, true);
                });
            }
            
            // Email input handling
            if (elements.emailInput) {
                elements.emailInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const email = e.target.value.trim();
                        if (email) searchUserByEmail(email, true);
                    }
                });
                
                // Simplified input validation
                elements.emailInput.addEventListener('input', (e) => {
                    const email = e.target.value;
                    const isValid = email.includes('@') && email.includes('.');
                    
                    if (email && !isValid) {
                        e.target.classList.add('border-red-300');
                        e.target.classList.remove('border-gray-300');
                    } else {
                        e.target.classList.remove('border-red-300');
                        e.target.classList.add('border-gray-300');
                    }
                });
            }

            // User action buttons
            if (elements.promoteBtn) elements.promoteBtn.addEventListener('click', promoteUser);
            if (elements.demoteBtn) elements.demoteBtn.addEventListener('click', demoteUser);
            if (elements.deleteBtn) elements.deleteBtn.addEventListener('click', deleteUser);

            // Admin refresh
            if (elements.refreshAdminsBtn) elements.refreshAdminsBtn.addEventListener('click', () => loadAdmins(true));
            
            // Setup keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Simplified focus management
            document.addEventListener('focusin', (e) => {
                if (e.target.matches('button, input, select, textarea')) {
                    e.target.classList.add('focus-visible');
                }
            });
            
            document.addEventListener('focusout', (e) => {
                if (e.target.matches('button, input, select, textarea')) {
                    e.target.classList.remove('focus-visible');
                }
            });
        }

        // Update top-level stats (only admins count for privacy)
        async function updateBaseStats() {
            try {
                const adminsColl = window.firebaseCollection(window.firebaseDB, 'admins');
                const adminsCountSnap = await window.firebaseGetCountFromServer(adminsColl);
                const adminsCount = adminsCountSnap.data().count || 0;
                const adminsEl = document.getElementById('total-admins');
                if (adminsEl) adminsEl.textContent = String(adminsCount);
            } catch (_) {
                // Fallback to dash on error
                const adminsEl = document.getElementById('total-admins');
                if (adminsEl) adminsEl.textContent = '-';
            }
        }

        // Initialize when Firebase is ready
        function waitForFirebase() {
            if (window.firebaseAuth && window.firebaseDB) {
                initializeAuth();
                setupEventListeners();
            } else {
                setTimeout(waitForFirebase, 100);
            }
        }

        // Start initialization
        waitForFirebase();

        // Clear search function
        function clearSearch() {
            const searchInput = document.getElementById('user-email-search');
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
            }
            
            // Reset to initial state
            currentSearchedUser = null;
            currentUserInvoices = [];
            document.getElementById('initial-user-state').classList.remove('hidden');
            document.getElementById('user-data-display').classList.add('hidden');
            document.getElementById('no-user-found').classList.add('hidden');
            
            showNotification('Search cleared', 'info');
        }

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + K to focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.getElementById('user-email-search');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                }
                
                // Escape to clear search
                if (e.key === 'Escape') {
                    const searchInput = document.getElementById('user-email-search');
                    if (searchInput && document.activeElement === searchInput) {
                        clearSearch();
                    }
                }
                
                // Tab navigation
                if (e.key === 'Tab') {
                    // Add focus indicators
                    document.body.classList.add('keyboard-navigation');
                }
            });
            
            // Remove keyboard navigation class on mouse use
            document.addEventListener('mousedown', () => {
                document.body.classList.remove('keyboard-navigation');
            });
        }

        // Enhanced notification system
        function showEnhancedNotification(message, type = 'info', duration = 4000) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full ${
                type === 'success' ? 'bg-gradient-to-r from-green-500 to-green-600 text-white' :
                type === 'error' ? 'bg-gradient-to-r from-red-500 to-red-600 text-white' :
                type === 'warning' ? 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-white' :
                'bg-gradient-to-r from-blue-500 to-blue-600 text-white'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        ${type === 'success' ? '<svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' :
                        type === 'error' ? '<svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' :
                        '<svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>'}
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <div class="ml-auto pl-3">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="inline-flex text-white hover:text-gray-200 focus:outline-none focus:text-gray-200 transition ease-in-out duration-150">
                            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, duration);
        }

        // Robust Confirmation System with Better Action Handling
        let confirmResolve = null;
        let isConfirmOpen = false;
        let currentEventListeners = [];

        function showConfirm(options = {}) {
            const {
                title = 'Confirm Action',
                message = 'Are you sure you want to proceed with this action?',
                confirmText = 'Confirm',
                cancelText = 'Cancel',
                confirmButtonClass = 'confirm-btn-danger'
            } = options;

            // Always clean up any existing dialog first
            hideConfirm();

            const overlay = document.getElementById('confirm-overlay');
            const titleEl = document.getElementById('confirm-title');
            const messageEl = document.getElementById('confirm-message');
            const cancelBtn = document.getElementById('confirm-cancel');
            const actionBtn = document.getElementById('confirm-action');

            // Set content
            titleEl.textContent = title;
            messageEl.textContent = message;
            cancelBtn.textContent = cancelText;
            actionBtn.textContent = confirmText;
            actionBtn.className = `confirm-btn ${confirmButtonClass}`;

            // Show dialog
            overlay.classList.add('show');
            isConfirmOpen = true;

            // Return promise
            return new Promise((resolve) => {
                confirmResolve = resolve;

                // Create event handlers
                const handleConfirm = () => {
                    hideConfirm();
                    resolve(true);
                };

                const handleCancel = () => {
                    hideConfirm();
                    resolve(false);
                };

                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        hideConfirm();
                        resolve(false);
                    }
                };

                const handleEnter = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Immediately hide the popup
                        const overlay = document.getElementById('confirm-overlay');
                        if (overlay) {
                            overlay.classList.remove('show');
                            overlay.style.display = 'none';
                        }
                        
                        // Clean up and resolve
                        hideConfirm();
                        resolve(true);
                    }
                };

                const handleOutsideClick = (e) => {
                    if (e.target === overlay) {
                        hideConfirm();
                        resolve(false);
                    }
                };

                // Add event listeners
                actionBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
                document.addEventListener('keydown', handleEscape);
                document.addEventListener('keydown', handleEnter);
                overlay.addEventListener('click', handleOutsideClick);

                // Store cleanup function
                const cleanup = () => {
                    actionBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    document.removeEventListener('keydown', handleEscape);
                    document.removeEventListener('keydown', handleEnter);
                    overlay.removeEventListener('click', handleOutsideClick);
                };

                // Store cleanup function and mark as current
                overlay.dataset.cleanup = cleanup;
                currentEventListeners.push(cleanup);
            });
        }

        function hideConfirm() {
            const overlay = document.getElementById('confirm-overlay');
            if (overlay) {
                // Immediately hide the overlay
                overlay.classList.remove('show');
                overlay.style.display = 'none';
                
                // Cleanup all event listeners
                if (overlay.dataset.cleanup) {
                    try {
                        overlay.dataset.cleanup();
                            } catch (e) {
            // Silent error handling for production
        }
                    delete overlay.dataset.cleanup;
                }

                // Cleanup any stored event listeners
                currentEventListeners.forEach(cleanup => {
                    try {
                        cleanup();
                            } catch (e) {
            // Silent error handling for production
        }
                });
                currentEventListeners = [];
                
                // Reset display after a short delay
                setTimeout(() => {
                    if (overlay) {
                        overlay.style.display = '';
                    }
                }, 200);
            }
            isConfirmOpen = false;
        }

        // Force cleanup on page unload
        window.addEventListener('beforeunload', hideConfirm);

        // Global error handler for confirmation system
        window.addEventListener('error', function(e) {
            if (e.target && e.target.closest('#confirm-overlay')) {
                hideConfirm();
            }
        });

        // Ensure cleanup on any navigation
        window.addEventListener('popstate', hideConfirm);
        window.addEventListener('beforeunload', hideConfirm);

        // Debug function to check confirmation system status
        function debugConfirmSystem() {
            const overlay = document.getElementById('confirm-overlay');
            // Debug information removed for production
        }

        // Legacy functions for backward compatibility
        function showConfirmationModal(options = {}) {
            return showConfirm(options);
        }

        function showConfirmationPopup(options = {}) {
            return showConfirm(options);
        }

        // Performance optimizations
        function optimizePerformance() {
            // Lazy load images
            const images = document.querySelectorAll('img[data-src]');
            if (images.length > 0) {
                const imageObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                            imageObserver.unobserve(img);
                        }
                    });
                });
                
                images.forEach(img => imageObserver.observe(img));
            }
            
            // Debounce scroll events
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    // Handle scroll-based optimizations
                }, 16); // ~60fps
            }, { passive: true });
            
            // Optimize resize events
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    // Handle resize-based optimizations
                }, 100);
            }, { passive: true });
        }

        // Initialize performance optimizations
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', optimizePerformance);
        } else {
            optimizePerformance();
        }
    </script>
</body>
</html>


